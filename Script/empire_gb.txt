Import "CommUtil.mql"
Import "EmpireOcr.mql"
Import "PictureUtil.mql"

Dim DELAY_OPERATE_RANK = Array(300,500,1000)
Dim screenX = GetScreenX(), screenY = GetScreenY()
Dim MINUTE_ONE = 60, MINUTE_HALF = 30
Dim SPY_SUC_RATE = 12

//全局找图变量
Dim intXY=Array(2), X=0, Y=1, intX=-1, intY=-1, baseX = 0, baseY = 0

///////全局配置///////////////////////////////////////////////////////////////
Dim townFlags = Array(true, true, true, true, true, true, true, true)

//gBuild全局设置(buidlArmy为序号+1)， gCity城市设置, gBuildArmyMix混合模式"0,1,2"
Dim gBuildArmy=102, gBuildArmyNum=1, gBuildTool=4, gBuildArmyMix="", gHospital = 5
Dim gCityBuildTool  = Array(-1,-1,-1,-1,3,3,3,4)
Dim gCityBuildArmy  = Array(-1,-1,-1,-1, 102, 102, -1, 102)
Dim gTimer = 30, gTimerPriority = 10, gCityRecruitTimer = 20
Dim gFirstStartCity = 0, gLastExePriorityNo = 0
//1:youmu，2：wushi  | gFastCampaingFlag 0:normal, 1:fast+wood 2:fast+iron
Dim gCampaignType = 0  , gCampaignMinTimer = 10, gFastCampaingFlag = 1
Dim gSkipBrigandMap = Array(0,0,0,0,0,0,0,0)

Dim gBrmdEnable = True, gBrmdBuildType=1
Dim gTaskEnable = true, gTranEnable=false, gOutCmdEnable=false, gHelpRecruitEnable=True
///////全局配置///////////////////////////////////////////////////////////////

//攻击单位的最低值（远，近）
Dim gAttackArmyLong = 80, gAttackArmyShort=90

//
Dim cityDefenceInfo
Dim armyArray, armyDefImagesArray, armyAtkShortImages, armyAtkLongImages, armyHsptRtnImagesArray, armyCannonImages
Dim targetArray, curCampaignTowerArray , nomadsTowerArray, samuraiTowerArray, foreignTowerArray
//进攻波次
Dim atkWavesMark,commanderArray,brigandsCmd,brigandsTower

//加载自定义字库解析
EmpireOcr.loadFontLib()

Function main
    //初始化基础数据
    init()

	//selectCommander(7)
	//readEnimyInfo(1)
	//cityRecruit(40, 1)
	
	//selectSoldierNum2("Attachment:slt_tool_iron_ladder.png", 5, 4, false)
	
	//TracePrint FindPicFull("Attachment:map_grass_flag.png")
	//TracePrint FindPic( 0, 0, 0, 0, "Attachment:map_grass_flag.png", "000000", 0, 1, intX, intY)
	//TracePrint intX & "," & intY
	//TracePrint gotoWorldMap(0)
	//TracePrint Ocr(230,512,245,530, "2A3748-303030|495A6B-202020|667B8C-201510", 0.9)
	
    //atk 测试
    Dim data = Array(0,551,566,11,91,0,0,0,0) 
    //atkSamurai(data)
    //dealOneTarget(data, true, true)
    //Delay 15*60000
    //outerCommand
    //buildRoom(1)
	
	//atkBerimondPlan()
	
	//buildRoom(2)
	//buyTool(400,1)

    //deleteAllEquip
    //deleteGem	
	
    //Dim img = armyAtkArray(4) & "|" & armyAtkArray(39)& "|" & armyAtkArray(40) & armyAtkArray(41)& "|" & armyAtkArray(42)
    //TracePrint img
    //TracePrint FindPic(30, 205, 125, 306, img, "303030",0,0.9,intX,intY)
	

    //gotoCity (8)
    //gotoWorldMap(5)
    //gotoMainMap()
    //campaignBlade
	
    //clearPopWindow 
    //clearPopWindowReconn
	
    //cityRecruitPre (0)
    //cityBuildToolPre(0)
	
    //campaignTask(nomadsTowerArray)
    //campaignBerimond()
    //transportGoods
	
    //readMovements
    //TracePrint readCommander()
	
	
    //cityHospital(0)
    //helpOther

    //cityBuildToolPre(2)
	
    //clearPopWindow
    
    gotoMainMap
    readMovements
	campaignTask (curCampaignTowerArray)
	
	//berimondRecruit()
	//campaignBerimond()
    
    //doTask
    
    //cityRecruitCannonArmy 
	
	
    mainLoop
    //simpleLoop
End Function

Function cityRecruitCannonArmy
    TracePrint "fast recuit cannon soldier"
    Dim bBuildArmy=gBuildArmy, bBuildArmyNum = gBuildArmyNum
    Dim bCityBuildArmy  = gCityBuildArmy
    Dim bCityRecruitTimer = gCityRecruitTimer
    gBuildArmy = 5

    gBuildArmyNum = 0
    gCityBuildArmy = Array(-1, -1, -1, -1, -1, -1, -1, -1)
    gCityRecruitTimer = 0
    For i = 0 To 6
        cityRecruitFast 	
    Next
    gBuildArmy = bBuildArmy
    gBuildArmyNum = bBuildArmyNum
    gCityBuildArmy = bCityBuildArmy
    gCityRecruitTimer = bCityRecruitTimer
End Function

Function doTask
	If gTaskEnable = False Then 
		Exit Function
	End If
	
	clearPopWindow
	gotoCity (0)
	
	tapPic ("Attachment:market_task_entry.png")
	Delay 400
	
	if tapPic ("Attachment:op_task_gather.png") Then
		Delay 1000
	End If
	
	FindPicFull("Attachment:op_task_doing.png")
	If intX > -1 and intY >-1 Then 
		TracePrint "Task already doing..."
	Else
		If tapPic("Attachment:op_task_do.png") Then 
			TracePrint Now() & " start task ... "
		End If
	End If
End Function

Function testA()
    Dim startX = 0, startY = 0
    Do While True
		
        FindPicArea(startX, startY, "Attachment:village_food.png")
        TracePrint "x,y => " & intX & "," & intY
        If intX = -1 And intY = -1 Then 
            Exit Do
        End If
		
        startX = intX + 2
        startY = intY + 2
    Loop
End Function

Function customAtk
	
End Function

//constant
Dim SIDE_CENTER=0, SIDE_LEFT=1, SIDE_RIGHT=2, SIDE_INNER=3
Dim DF_WALL=0,DF_DOOR=1,DF_RIVER=2,DF_LONG=3,DF_SHORT=4,DF_PW_SHORT=5,DF_PW_LONG=6,DF_NUM_SHORT=7,DF_NUM_LONG=8
//Dim ARMY_NAME=0,ARMY_ATK_S=1,ARMY_ATK_L=2,ARMY_DF_S=3,ARMY_DF_L=4,ARMY_DF_PIC=8,ARMY_TYPE_ATK=9,ARMY_TYPE_LAND0=10,ARMY_TYPE_LAND9=11,ARMY_TYPE_YM=12

//=============================================================================
// main loop
// 主循环次数，每次循环开始时间，每次atk开始时间
Dim gRunCounter = 0, gMainLoopStartTime, gAtkLoopStartTime
//=============================================================================
Function mainLoop
    Dim lastAtkBreaktime = 0, curTime,sleepTime, atkStartTime
    Do While True
        gMainLoopStartTime = Time()
        TracePrint "==================================================================================="
        TracePrint Now() & " 一级循环..." & gMainLoopStartTime
        TracePrint "==================================================================================="
        
        clearPopWindowReconn()
        
        gotoMainMap()
        
        doTask()
        
        //autoCreate()
        
        helpOther()
        
        TracePrint Now() & " Do auto attacking..."
        For i = 0 To 15

        	
            //dis connect检测
            If isDisConnect() Then 
                //重连，并等待30S
                clearPopWindowReconn 
                Delay MINUTE_HALF *1000
                If isDisConnect() Then 
                    TracePrint Now() & " 其他设备登录"
                    Exit For
                End If	
            End If
        	
            atkStartTime = Time()
        	TracePrint "---------------------------------------------------------------------------------"
        	TracePrint Now() & " 二级循环..." & atkStartTime
        	
            //transport
            gotoMainMap 
            //transportGoods()
        	
            //fast recruit
            //cityRecruitFast()
        	
            gAtkLoopStartTime = atkStartTime
            Dim result = autoAtk (false)
            //Dim result = 1
        	
            //外部命令申请
            outerCommand()
        	
            If result = 1 Then 
                curTime = Time()
                Dim lest =  gTimer * MINUTE_ONE - (curTime - gMainLoopStartTime)
                sleepTime = gTimerPriority*MINUTE_ONE - (curTime - atkStartTime)
        		
                Dim recuitLest = gCityRecruitTimer * MINUTE_ONE - (curTime - glastCityRecruitTime)
                If gBuildArmyNum > 0 And recuitLest < sleepTime Then 
                    sleepTime = recuitLest
                End If
        		
                If lest < sleepTime Then 
                    sleepTime = lest
                End If
        		
                TracePrint Now() & " Attack Cooldown：" & sleepTime
                Delay sleepTime * 1000
            End If
        	
            //两次结束时间太短，退出
            curTime = Time()
        	
        	/*
        	If curTime - lastAtkBreaktime < 2*MINUTE_ONE Then 
        		TracePrint Now() & " 其他设备登录"
        		Exit For
        	End If
        	lastAtkBreaktime = curTime
        	*/
        	
            If curTime - gMainLoopStartTime > gTimer * MINUTE_ONE Then 
                Exit For
            Else 
                TracePrint Now() & " 休眠30S, 再启动"
                Delay MINUTE_HALF *1000
            End If
        Next
        TracePrint Now() & " Finish auto attacking..."
        
        curTime = Time()
        //TracePrint "xxxx: " & curTime & ", gMainLoopStartTime:" & gMainLoopStartTime
        If curTime - gMainLoopStartTime < gTimer * MINUTE_ONE Then 
            sleepTime =  gTimer * MINUTE_ONE - (curTime - gMainLoopStartTime)
            TracePrint Now() & " 等待下次主循环启动，时长：" & sleepTime
            Delay sleepTime*1000
        End If
        
        //reset start city
        gFirstStartCity = 0
        gRunCounter = gRunCounter + 1
        
        If gRunCounter Mod 2 = 0 Then 
            deleteAllEquip
        End If
    Loop
End Function

Function simpleLoop
    Dim lastAtkBreaktime = 0, curTime,sleepTime, atkStartTime
    Do While True
        gMainLoopStartTime = Time()
        TracePrint Now() & " 开始执行..." & gMainLoopStartTime
        
        clearPopWindowReconn()
        
        gotoMainMap()
        
        campaignTask (curCampaignTowerArray)
		
        TracePrint "Delay 5 minutes."
        Delay 5*60*1000
    Loop
End Function

Function buyTool(amount, type)
	Dim picArray = Array("Attachment:p_market_tools_ladder.png","Attachment:op_hospital_input_minus.png")
	If type = 2 Then 
		picArray(0) = "Attachment:p_market_tools_hammer.png"
	End If
	TracePrint Now() & " Buy Tools " & amount & ":" & picArray(0)
	
	For i = 1 to amount
		If tapPic2(picArray, DELAY_OPERATE_RANK(1)+100) Then 
			actionConfirm 
		Else 
			actionCancle
		End If
	Next
End Function

Dim gLastCmdSn = 10
Function outerCommand()
    If gOutCmdEnable = False Then 
    	Exit Function
    End If
    
    Dim data = Url.Get("http://112.74.64.28/command.html")
    Dim size = Len(data)
    If size > 0 And size < 100 Then 
        Dim commandArray = CommUtil.split2DimArray(data)
        For i = 0 To UBOUND(commandArray)
            //sn, command, parameter
            If CInt(commandArray(i, 0)) > gLastCmdSn Then 
                TracePrint "plan to execute " & Join(commandArray(i), ",")
                gLastCmdSn = CInt(commandArray(0, 0))
                If commandArray(i, 1) = "delay" Then 
                    Delay CInt(commandArray(i, 2)) * 60 * 1000
                ElseIf commandArray(i, 1) = "recruit" Then
                    If UBOUND(commandArray(i)) >= 4 Then 
                        Dim armyType = CInt(commandArray(i, 2))
                        Dim armyNum =  CInt(commandArray(i, 3))
                        Dim armyNumTimer =  CInt(commandArray(i, 4))
                        If (armyType >= 0 And armyType <= 5) or (armyType >= 39 And armyType <= 42) Then 
                            gBuildArmy =armyType
                        End If
						
                        If armyNum <= 5 Then 
                            gBuildArmyNum = armyNum
                        End If
						
                        If armyNumTimer > 10 And armyNumTimer < 60 Then 
                            gCityRecruitTimer = armyNumTimer
                        End If
                    End If
                    TracePrint "change recruit: gBuildArmy=>" & gBuildArmy & ", gBuildArmyNum=>" & gBuildArmyNum & ",gCityRecruitTimer=>" & gCityRecruitTimer
                ElseIf commandArray(i, 1) = "recruitfast" Then
                    cityRecruitCannonArmy
                ElseIf commandArray(i, 1) = "campaign" Then
                    Dim campaignType = CInt(commandArray(i, 2))
                    If campaignType < 10 Then 
                        gCampaignType = campaignType
						
                        //swith
                        If gCampaignType = 1 Then 
                            curCampaignTowerArray = nomadsTowerArray
                        ElseIf gCampaignType = 2 Then	
                            curCampaignTowerArray = samuraiTowerArray
                        ElseIf gCampaignType = 3 Then	
                            curCampaignTowerArray = foreignTowerArray
                        End If
                    End If
                    TracePrint "change campaign: " & gCampaignType
                ElseIf commandArray(i, 1) = "atk_goto" Then
                    gLastExeTowerNo = CInt(commandArray(i, 2))
                    TracePrint "atk_goto " & gLastExeTowerNo
                End If
				
                TracePrint "execute over."
            Else 
                //TracePrint "skip command " & Join(commandArray(i), ",")
            End If
        Next
    End If
End Function

Function initConfig
    Dim i=0
    Do While i <= UBOUND(townFlags)
        i = i + 1
        townFlags(i) = ReadUIConfig("tower"&i)
    Loop

    gBuildArmy = ReadUIConfig("cbxSolderType")
    If ReadUIConfig("chkSingleMode") = true Then 
        gBuildArmyNum = 1
    Else 
        gBuildArmyNum = 0
    End If
    gBuildTool = ReadUIConfig("cbxToolType")
	
End Function

Function waitLoadingPage
    //等待加载
    //TracePrint Now() & " == " 
    Delay 2000
    
    //TracePrint Now()
    Dim counter = 0
    Do While counter < 30
        counter = counter+1
        FindPicFull "Attachment:launch.png|Attachment:loading.png|Attachment:loading_desert.png|Attachment:loading_fire.png"
        If intX > 0 and intY > 0 Then 
            //TracePrint Now() & " ==1 " 
            Delay 1000
        Else 
            Exit Do
        End If
    Loop
    
    //TracePrint Now() & " ==2 " 
    Delay DELAY_OPERATE_RANK(2)
End Function

//清理所有弹出窗口，并复原到草原大地图
Function clearPopWindowReconn
    
    //re-connect
    FindPicFull "Attachment:re-connect.png"
    If intX > 0 and intY > 0 Then 
        //重连
        TracePrint Now() & " 开始重新连接"
        Delay DELAY_OPERATE_RANK(2)
        Tap intX, intY
    	
        Call waitLoadingPage()
        TracePrint Now() & " 重新连接完成"
    End If

    
    clearPopWindow
End Function

Function isDisConnect()
    FindPicFull "Attachment:re-connect.png"
    If intX > 0 and intY > 0 Then 
        isDisConnect = True
    Else 
        isDisConnect = False
    End If
End Function

//清理所有弹出窗口，并复原到草原大地图
Function clearPopWindow
    clearPopWindowNoReset()
    
    //TracePrint "test"
	tapMenuReset()
End Function

Function clearPopWindowNoReset
    FindPicFull "Attachment:close_esc.png"
    If intX > 0 or intY > 0 Then 
        Tap intX+16, intY+16
        Delay DELAY_OPERATE_RANK(1)
    End If
    
    //关闭弹出页面
    
    Dim bitMapPth = "Attachment:close_benefit.png|Attachment:close_benefit_time.png|Attachment:close_google.png|Attachment:colse_cancle.bmp|Attachment:close_return.png|Attachment:colse_confirm.png|Attachment:close_esc.png"
    
    For i=0 to 5
        FindPicFull bitMapPth
        If intX > 0 or intY > 0 Then 
            //TracePrint "Back"
            KeyPress "Back"
            Delay DELAY_OPERATE_RANK(1)
        Else 
            Exit For
        End If
    Next
    
    
    Do While true
        FindPicFull bitMapPth
        If intX > 0 or intY > 0 Then 
            TracePrint "tap clear..."	
            Tap intX+16, intY+16
            Delay DELAY_OPERATE_RANK(1)
        Else 
            Exit Do
        End If
    Loop
End Function


Function gotoMainMap()
    gotoMainMap = gotoMainMap2(false)
End Function

Function gotoMainMap2(isInner)
    gotoMainMap2 = False
    clearPopWindow()
    
    If tapPic("Attachment:banner_navigate.png") = False Then 
        TracePrint "找不到导航图标"
    End If
    Delay DELAY_OPERATE_RANK(0)
    
    
    If tapPic("Attachment:banner_m_nav_pos.png") = False Then 
        if tapPic("Attachment:banner_m_nav_tower.png") = True and isInner=false Then
            waitLoadingPage()
            gotoMainMap2 = gotoMainMap2(true)
        Else 
            TracePrint "找不到地图导航图标"
        End If
        Exit Function
    End If
    Delay DELAY_OPERATE_RANK(1)
        
    FindPicFull "Attachment:map_icon_main.png"
    If intX > 0 And intY > 0 Then 
        Tap intX, intY
        waitLoadingPage 
        gotoMainMap2 = True
    Else 
        TracePrint "找不到地图定位图标"
        gotoMainMap2 = False
    End If
End Function

Function helpOther
    clearPopWindow 
    FindPicArea 0, 600, "Attachment:op_help_other_tip.png"
    If intX = -1 or intY = -1 Then 
        Exit Function
    End If
	
    tapPosition intX, intY
    Delay DELAY_OPERATE_RANK(2)
	
    FindPicFull "Attachment:op_help_other_do.png"
    If intX > -1 And intY > -1 Then 
        TracePrint Now() & " Help other. "
        tapPosition intX, intY
    End If
	
    close
End Function

//自动建造
Function autoCreate
    Dim cityX = 0
    Dim cityY = 0
    Dim cityAfterIceX = 0
    Dim cityAfterIceY = -20
    Dim index = gFirstStartCity

    //混合模式下，获取当次
    If len(gBuildArmyMix) > 0 Then 
        Dim tmp = Split(gBuildArmyMix, ",")
        Dim idx = gRunCounter mod (UBound(tmp)+1)
        gBuildArmy = CInt(tmp(idx))
        TracePrint "Current build army: " & gBuildArmy
    End If
    
    //record start time
    glastCityRecruitTime = Time()
    Do while index <= UBOUND(townFlags)
    	If townFlags(index) Then 
        	gotoCity (index)
        	cityAll(index)
    	Else 
        	//cancel
        	TracePrint "当前城市无任务," & index & "[" & intX & "," & intY & "]"
        	call close()
    	End If
        index = index + 1
    Loop
End Function

Function gotoCity(cityIndex)
    Dim thisCityX =-1, thisCityY=-1
    gotoCity = False
        
    clearPopWindow
        
    //城堡循环逻辑
    If tapPic2(Array("Attachment:banner_navigate.png", "Attachment:banner_m_nav_pos.png"), DELAY_OPERATE_RANK(1)) = False Then 
        TracePrint "无法导航图标"
        Exit Function
    End If
    Delay DELAY_OPERATE_RANK(2)
        
    //查找冰川，如果已经是冰川之后的城堡则拖动
    Dim result = -1
    If cityIndex < 4 Then 
        //(Y坐标相对上个偏移10)
        result = FindPicArea2(310,190,450,265, "Attachment:map_icon_tower.png|Attachment:map_icon_tower2.png")
        If intX > 0 And intY > 0 Then 
            thisCityX = intX
            thisCityY = intY + 64*cityIndex
        Else 
            //退出
            TracePrint Now() & " 退出循环：找不到城堡图标," & cityIndex & "[" & intX & "," & intY & "]"
        End If        
    Else 
        Call dragMove(intX, intY, 0, -300)
        Delay DELAY_OPERATE_RANK(1)
           	
        Dim bitMapPth
        If cityIndex = 8 Then 
            bitMapPth = "Attachment:map_icon_b.png|Attachment:map_icon_b_x.png"
            FindPicFull bitMapPth
            //MessageBox index&":"&iceX&","&iceY
            If intX > 0 and intY > 0 Then 
                //-40,15; 295,15,   80,15;64
                thisCityX = intX + 295
                thisCityY = intY + 15
            Else 
                //退出
                TracePrint "退出循环：找不到B图标," & cityIndex & "[" & intX & "," & intY & "]"
            End If
        Else 
            bitMapPth = "Attachment:main_4_bingchuan.bmp|Attachment:main_4_bingchuan_2.bmp"
            FindPicFull bitMapPth
            //MessageBox index&":"&iceX&","&iceY
            If intX > 0 and intY > 0 Then 
                //80,15;64
                thisCityX = intX + 80
                thisCityY = intY + 15 + 64 * (cityIndex - 4)
            Else 
                //退出
                TracePrint "退出循环：找不到冰川图标," & cityIndex & "[" & intX & "," & intY & "]"
            End If
        End If
    End If
        
    If thisCityX > -1 Then 
        tapPosition thisCityX, thisCityY
        //加载
        waitLoadingPage()
        clearPopWindow()
        gotoCity = True
    End If
End Function

Function dragMove(x, y, dragX, dragY)
    TouchDown x, y, 1
    TouchMove x+dragX, y+dragY, 1, DELAY_OPERATE_RANK(0)
    Delay DELAY_OPERATE_RANK(0)
    Delay 100
    TouchUp 1
End Function

Function close
    //cancel
    FindPicFull "Attachment:close_cancle.png"
    If intX > 0 And intY > 0 Then 
        Tap intX, intY
        Delay DELAY_OPERATE_RANK(1)
    End If
End Function

//打开城市
Function cityAll(index)
    TracePrint Now() & " Open city: " & index
    
    If index<=UBOUND(townflags) And townFlags(index) Then 
		
        //===============================================================
        cityRecruitPre (index)
        
        //================================================================
        //工具
        cityBuildToolPre(index)
        //==================================================================
        //hospital
        cityHospital(index)
    Else 
        //cancel
        TracePrint "当前城市无任务," & index & "[" & intX & "," & intY & "]"
        call close()
    End If
End Function
//=======================================================

Function cityRecruitPre(cityIndex)
    If gCityBuildArmy(cityIndex) <> -2 And Not(gBuildArmy<0 and gCityBuildArmy(cityIndex)<0) Then 
        Dim imgArray = Array("Attachment:banner_military.png", "Attachment:banner_m_mil_army.png")
        Dim armyType = gCityBuildArmy(cityIndex)
        If tapPic2(imgArray, DELAY_OPERATE_RANK(1)) = True Then 
            //招兵
            If armyType < 0 Then 
                armyType = gBuildArmy
            End If
            cityRecruit(armyType, gBuildArmyNum)
        End If
        
        //close and clear
        clearPopWindow()
    End If
End Function

Dim glastCityRecruitTime = 0
Function cityRecruitFast
    If gBuildArmyNum = 0 and (gBuildArmy < 2 or gBuildArmy >5) Then 
        Exit Function
    End If
	
    If glastCityRecruitTime = 0 and gFirstStartCity > 0 Then 
        glastCityRecruitTime = Time()
        Exit Function
    End If
	
	Dim intervalTime = Time() - glastCityRecruitTime
    If intervalTime < gCityRecruitTimer * MINUTE_ONE Then 
        TracePrint Now() & "Recuit 小于最小间隔时间. => " & intervalTime
        Exit Function
    End If
    glastCityRecruitTime = Time()
	
    TracePrint Now() & " 开始招募："
	
    for i=0 to 7 
        If townFlags(i) Then
        	gotoCity (i)
        	cityRecruitPre (i)
        End If
    Next
	
    helpOther()
	
    TracePrint Now() & " 招募结束："
End Function

//造兵()
Function cityRecruit(soldierIndex, singleMode)
    Delay DELAY_OPERATE_RANK(2)
    If soldierIndex < 0 Then 
        Exit Function
    End If

    //是否远程，切换远程面板后需要暂停一定时间
    If armyArray(soldierIndex, ARMY_ATK_L) > 0 Then 
        FindPicFull "Attachment:p_recruit_tab_long.png"
        If intX > 0 And intY > 0 Then
            tapPosition2 intX, intY, DELAY_OPERATE_RANK(0)
        End If
    End If
    
    Dim count = checkAvaiableCount()   
    If count = 0 Then 
        Exit Function
    End If
    
    //Find
    Dim px = -1,py = -1
    Delay DELAY_OPERATE_RANK(1)
    For i = 0 To 10
        //区域
        FindPicArea2 33, 410, 126, 696, armyArray(soldierIndex, ARMY_PIC_ATK)
        If intX > 0 And intY > 0 Then 
            px = intX
            py = intY
    		
            Delay DELAY_OPERATE_RANK(2)
            Exit For
        End If
    	
        //move for more
        dragMove(80,555, 0, -140)
    Next
    
    If px = -1 or py =-1 Then 
        TracePrint "Can not build soldire: " & armyArray(soldierIndex, ARMY_NAME)
        Exit Function
    End If
    
    FindPicArea2 0, py, screenX, py + 100, "Attachment:op_recruit_do.png"
    If intX = -1 or intY = -1 Then 
        TracePrint "不能建造，级别不够"
        Exit Function
    End If
    
    TracePrint "Recruite soldier base position: " & px & "," & py
    
    Delay DELAY_OPERATE_RANK(1)
    Dim tryTimes = 0
    Do While count > 0 and tryTimes < 3
        tapPosition(5,py+25)
        For i=1 to count
            //单个
            If singleMode > 0 then
                //relative: 255, 25
                For j = 1 To singleMode
                    //TracePrint i & "," & px & "," & py
                    tapPosition px + 255, py + 25
                    //首次有概率点击无效
                    //If j = 1 Then 
                    	//Dim tmp = EmpireOcr.ocrNumber(px+155, py+65, px+175, py+75)
                    	Dim tmp = Ocr(px+195,py+20, px+210, py+40, "2A3748-303030|495A6B-202020|667B8C-201510", 0.9)
                    	//TracePrint "recruite soldier amount: " & tmp
                    	If tmp <> "" And CInt(tmp) <> 1 Then
                        	//op_plus.png
                        	tapPosition px + 255, py + 25
                        End If
                    //End If
                Next
            End If
        	
            tapPosition(px+345, py+30)
        Next
    	
        tryTimes = tryTimes+1
        Delay DELAY_OPERATE_RANK(0)
        count = checkAvaiableCount()
    Loop

    
    FindPicArea2(0, 230, screenX, 350, "Attachment:p_recruit_buy_slot.png")
    Dim finishX = intX
    //TracePrint "finishX: " & finishX 
    //start:70,290,  H:83
    
    //skip help other
    If gHelpRecruitEnable = False Then 
    	Exit Function
    End If
    
    Dim helpClickPx = 70
    For i=0 to 4
        //请求帮助
        helpClickPx = 70 + i * 83
        If finishX <> -1 And helpClickPx > finishX Then 
            //TracePrint "px: " & px & ", i" & i 
            Exit For
        End If
        
        tapPosition helpClickPx, 290
        Delay DELAY_OPERATE_RANK(0)
        
        FindPicFull "Attachment:op_army_help.png"
        //TracePrint "x: " & intX & ", y" & intY
        If intX > 0 And intY > 0 Then 
            tapPosition intX, intY
        End If
    Next
End Function

Function checkAvaiableCount
    //count amount Y:230,350
    Dim count = 0, startX=0
    CommUtil.capKeepMem(0)
    Do While True
        FindPicArea2 startX, 230, screenX, 350, "Attachment:build_available_loc1.png|Attachment:build_available_loc2.png"
        If count=5 or intX = -1 or intY = -1 Then 
            Exit Do
        End If
    	
        startX = intX + 76
        count = count+1
    Loop
    CommUtil.capRealseMem 
    checkAvaiableCount = count
End Function

Function cityBuildToolPre(index)
    clearPopWindow
    If tapPic2(Array("Attachment:banner_military.png", "Attachment:banner_m_mil_tool.png"), DELAY_OPERATE_RANK(1)) Then 
        If gCityBuildTool(index) = -1 Then 
            Call createShield(gBuildTool)
        Else 
            Call createShield(gCityBuildTool(index))
        End If
    Else 
        TracePrint "无法打开工具制造面板"
    End If
    close()
End Function

Function createShield(toolType)
    Delay DELAY_OPERATE_RANK(2)
    If toolType = 0 Then 
        Exit Function
    End If
    
    Dim count = checkAvaiableCount()
    TracePrint "[createShield] build type,count => " & toolType& "," &count
    If count = 0 Then 
        Exit Function
    End If
    
    FindPicFull "Attachment:slt_tool_ladder.png"
    If intX > 0 And intY > 0 Then 
        Dim listX=intX, listY=intY
        Dim n = 0
        Dim targetX = - 1 ,targetY = - 1 
        Dim toolIconPath = "Attachment:slt_tool_shield.png"
        //类别
        If toolType = 1 Then
            toolIconPath = "Attachment:slt_tool_ladder.png"
        ElseIf toolType = 2 Then
            toolIconPath = "Attachment:slt_tool_hammer.png"
        ElseIf toolType = 3 Then
            toolIconPath = "Attachment:slt_tool_shield.png"
        ElseIf toolType = 4 then 
            toolIconPath = "Attachment:slt_tool_red_flag.png"
        Else 
            toolIconPath = "Attachment:slt_tool_shield.png"
        End If
        //MessageBox toolType&":"&toolIconPath
        //循环检查
        Do While n < 10
            FindPic 30,410,130,700,toolIconPath,"101010", 0, 0.9, intX, intY
            If intX > 0 And intY > 0 Then 
                targetX = intX
                targetY = intY
                Exit Do
            End If
            
            n = n + 1
            //TracePrint Now & "==10:" & listX & "," & listY
            Call dragMove(listX, listY, 0, -150)
        Loop
        Delay DELAY_OPERATE_RANK(1)
        
		//TracePrint "[createShield] targetX,Y => " & targetX & "," & targetX
        
        If targetX > 0 And targetY > 0 Then 
            FindPicArea targetX,targetY-50,"Attachment:op_recruit_do.png"
            //TracePrint "[createShield] x,y => " & intX & "," & intY
            Dim tapX = intX,tapY=intY
            
            If tapX > 0 And tapY > 0 Then 
            	
            	For buildCount=1 to count
                	//TracePrint "[createShield] tap"
                	tapPosition2(tapX+20, tapY+20, DELAY_OPERATE_RANK(1))
            	Next
            	
            	//[fix bug]: first tap may not effect.(count -> count+1)
            	count = checkAvaiableCount()
            	If count > 0 Then 
            		For buildCount=1 to count
                		//TracePrint "[createShield] tap"
                		tapPosition2(tapX+20, tapY+20, DELAY_OPERATE_RANK(1))
            		Next
            	End If
            End If
            //TracePrint "[createShield] finished " & count
        End If
    Else 
    	TracePrint "[createShield] failt to verify page identity."
    End If
End Function


Function cityHospital(cityIndex)
    clearPopWindow 
	
    //hospital
    If gHospital > 0 and gRunCounter Mod gHospital = 0 Then 
        If tapPic2(Array("Attachment:banner_military.png", "Attachment:banner_m_mil_hospital.png"), DELAY_OPERATE_RANK(1)) = false Then 
            TracePrint "无法打开医疗面板"
            Exit Function
        End If
        hospital(cityIndex)
    End If
End Function

//
Function hospital(cityIndex)
    FindPicFull "Attachment:p_hospital_tab_del.png"
    If intX = -1 or intY = -1 Then 
        close 
        Exit Function
    End If
	
    tapPosition intX, intY
    Delay DELAY_OPERATE_RANK(1)
		
    //400,205, 434,250->Y:101
    Dim keep=0, delX, delY
    Do While cityIndex < 4
        //删除图标
        FindPicArea2 400, 205+keep*101, 434, 250+keep*101,  "Attachment:op_hospital_del.png"
        If intX = -1 or intY = -1 Then 
            //TracePrint "exit :"
            Exit Do
        End If
        delX = intX
        delY = intY
		
        //确认类别
        //TracePrint "find:" &  retainArray(cityIndex)
        FindPic 30, 205 + keep * 101, 123, 306 + keep * 101, armyHsptRtnImagesArray(cityIndex), "303030",0,0.9,intX,intY
        If keep<5 And intX > -1 And intY > -1 Then 
            //TracePrint "reverse :" & keep
            keep = keep+1
        Else 
            //TracePrint "xxx:" & intX & "," & intY
            tapPosition delX + 5, delY + 10
            Delay  DELAY_OPERATE_RANK(1)
			
            //TracePrint "xxx2"
            FindPicArea2 60, 340, 120, 405, "Attachment:op_hospital_input_minus.png"
            If intX = -1 or intY = -1 Then 
                //TracePrint "xxx3"
                Exit Do
            End If
			
            tapPosition intX + 10, intY + 10
            actionConfirm 
            Delay DELAY_OPERATE_RANK(1)
			
            //may switch order
            keep = 0
        End If
    Loop
	
    FindPicFull "Attachment:p_hospital_tab_save.png"
    If intX = -1 or intY = -1 Then 
        close 
        Exit Function
    End If
    tapPosition intX+5, intY+5
	
	
    Dim count = 0, startX=0
    CommUtil.capKeepMem(0)
    Do While True
        FindPicArea2 startX, 230, screenX, 350, "Attachment:build_available_loc1.png"
        If count=5 or intX = -1 or intY = -1 Then 
            Exit Do
        End If
    	
        startX = intX + 76
        count = count+1
    Loop
    CommUtil.capRealseMem 
    //TracePrint count
	
    If count > 0 Then 
        FindPicFull "Attachment:op_hospital_cure.png"
        If intX > -1 and intY > -1 Then 
            For i = 1 To count
                tapPosition intX+20, intY+20
            Next
        End If
    End If
	
	
    FindPicFull "Attachment:p_hospital_slot_invalid.png"
    Dim finishX = intX
	
    //for help
    Dim helpClickPx = 70
    For i=0 to count-1
        //璇锋甯
        helpClickPx = 70 + i * 83
        If finishX <> -1 And helpClickPx > finishX Then 
            //TracePrint "px: " & px & ", i" & i 
            Exit For
        End If
        
        tapPosition helpClickPx, 290
        Delay DELAY_OPERATE_RANK(0)
        
        FindPicFull "Attachment:op_hospital_help.png"
        //TracePrint "x: " & intX & ", y" & intY
        If intX > 0 And intY > 0 Then 
            tapPosition intX, intY
        End If
        
    Next
    
    close
End Function


/////////////////////////////////////////////////////////////////
Function deleteAllEquip
    clearPopWindow
	
    tapPic2(Array("Attachment:banner_equipment.png","Attachment:p_equipment_tab_sell.png"), DELAY_OPERATE_RANK(2)*2)
    Delay DELAY_OPERATE_RANK(2)
	
    For i = 1 To 6
        deleteEquipment
		
        tapPosition2 425,260, DELAY_OPERATE_RANK(1)
    Next
    
    deleteGem
End Function

Function deleteEquipment
    Do While True
        FindPicArea2 80, 290, 375, 420, "Attachment:equipment_gray.png|Attachment:equipment_green.png|Attachment:equipment_purple.png|Attachment:equipment_green_hero.png"
        If intX = -1 or intY = -1 Then 
            Exit Do
        End If
		
        tapPosition intX + 10, intY + 10
        //FindPicArea2 340, 480, 440, 580, "Attachment:equipment_sell.png"
        FindPicFull "Attachment:equipment_sell.png"
        //		TracePrint "xxxx:"&intX&intY
        If intX > -1 or intY > -1 Then 
            tapPosition(intX+10, intY+10)
            actionConfirm 
            Delay DELAY_OPERATE_RANK(0)
        End If
    Loop
End Function


Function deleteGem
    Do While True
        FindPicArea2 80, 290, 375, 420, "Attachment:gem_lvl_2.png|Attachment:gem_lvl_3.png"
        If intX = -1 or intY = -1 Then 
            FindPicArea2 370, 290, 430, 420, "Attachment:p_equ_gem_go_right.png"
            If intX = -1 or intY = -1 Then 
                Exit Do
            Else 
                tapPosition intX+15, intY+15
            End If
        Else
            tapPosition intX + 10, intY + 10
            //FindPicArea2 340, 480, 440, 580, "Attachment:equipment_sell.png"
            FindPicFull "Attachment:equipment_sell.png"
            //		TracePrint "xxxx:"&intX&intY
            If intX > -1 or intY > -1 Then 
                tapPosition(intX+10, intY+10)
                actionConfirm 
                Delay DELAY_OPERATE_RANK(0)
            End If
        End If	
    Loop
End Function


Function dfSearchBoat()
    Do While True
        FindPicFull "Attachment:daofeng_boat.png"
        If intX > 0 And intY > 0 Then 
            Tap intX, intY
            Delay DELAY_OPERATE_RANK(0)
        Else 
            Exit Do
        End If
    Loop
End Function

/*
Function battle
		FindPicFull "Attachment:xxx.png"
		If intX > 0 And intY > 0 Then 
			Tap intX, intY
			Delay DELAY_OPERATE_RANK(0)
		Else 
			Exit Function
		End If

		//冷却中
		FindPicFull "Attachment:battle_wait.png"
		If intX > 0 And intY > 0 Then 
			Call close()
			Exit Function
		End If
		
		
End Function
*/

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
//
//
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
Dim TAGT_MAP=0, TAGT_X=1, TAGT_Y=2,TAGT_TYPE=3,TAGT_LVL=4,TAGT_SPY=5,TAGT_SPY_T=6,TAGT_ATK=7,TAGT_ATK_T=8

Function readAllEnimyCity(type)
    Dim allTargetInfo = Array(3)
    //中
    TracePrint "信息读取(中，左，右)"
    Delay DELAY_OPERATE_RANK(1)
    allTargetInfo(0) = readEnimyInfo(type)
		
    //左 55, 326
    //TracePrint "左侧信息读取"
    Tap 55, 326
    Delay DELAY_OPERATE_RANK(1)
    allTargetInfo(1) = readEnimyInfo(type)
	If allTargetInfo(1, DF_DOOR) <> -1 Then
		TracePrint "[ERROR] Fail to read info(LEFT)"
	End If

    //右 420,326
    //TracePrint "右侧信息读取"
    Tap 420, 326
    Delay DELAY_OPERATE_RANK(2)
	
    Tap 420, 326
    Delay DELAY_OPERATE_RANK(1)
    allTargetInfo(2) = readEnimyInfo(type)
	If allTargetInfo(2, DF_DOOR) <> -1 Then
		TracePrint "[ERROR] Fail to read info(RIGHT)"
	End If
	
    //回到正面
    Tap 55, 326
    Delay DELAY_OPERATE_RANK(1)
	
    readAllEnimyCity = allTargetInfo
End Function

Function readAllEnimyCity2(type)
    Dim allTargetInfo = Array(4)
    //中
    TracePrint "信息读取(中，左，右)"
    Delay DELAY_OPERATE_RANK(0)
    allTargetInfo(0) = readEnimyInfo(type)
		
    //左 55, 326
    //TracePrint "左侧信息读取"
    Tap 55, 326
    Delay DELAY_OPERATE_RANK(0)
    allTargetInfo(1) =  readEnimyInfo(type)

    //内部
    Tap 55, 326
    Delay DELAY_OPERATE_RANK(0)
    allTargetInfo(3) =  readEnimyInfo(type)
	
    Tap 55, 326
    Delay DELAY_OPERATE_RANK(0)
    allTargetInfo(2) =  readEnimyInfo(type)
	
    //回到正面
    Tap 55, 326
    Delay DELAY_OPERATE_RANK(0)
	
    readAllEnimyCity2 = allTargetInfo
End Function

Function gotoWorldMap(mapNo)
    TracePrint "goto map : " & mapNo
	
    gotoWorldMap = True
	
    clearPopWindow()
    If mapNo = 0 Then 
        gotoWorldMap = gotoMainMap()
    Else 
        //城堡循环逻辑
        If tapPic2(Array("Attachment:banner_navigate.png", "Attachment:banner_m_nav_pos.png"), DELAY_OPERATE_RANK(0)) = False Then 
            TracePrint "无法导航图标"
            Exit Function
        End If
        Delay DELAY_OPERATE_RANK(2)
		
        dragMove 130, 625, 0, -300
        Delay DELAY_OPERATE_RANK(2)
		
        If mapNo = 5 Then 
            //478-415=63
            FindPicFull "Attachment:map_icon_b.png|Attachment:map_icon_b_x.png"
            If intX > -1 and intY > -1 Then
                tapPosition(intX-40,intY+15)
                waitLoadingPage 
            Else 
                gotoWorldMap = False
            End If
        Else 
            //478-415=63
            FindPicFull "Attachment:map_icon_ice.png|Attachment:map_icon_ice1.png"
            If intX > -1 and intY > -1 Then
                tapPosition(intX-40,intY+20+(mapNo-1)*63)
                waitLoadingPage 
            Else 
                gotoWorldMap = False
            End If
        End If
    End If
    
    //verify
    Dim result = FindPic( 0, 0, 0, 0, "Attachment:map_grass_flag.png", "000000", 0, 1, intX, intY)
    FindPicFull "Attachment:map_grass_flag.png"
    //TracePrint result & "=>" & intX & "," & intY
    If mapNo = 0 and intX = -1 Then 
    	gotoWorldMap = False
    ElseIf mapNo > 0 and intX > -1 Then
    	gotoWorldMap = False
    End If
    
End Function

//===========================================================================
//
//
Dim curMap=0, maxAtk = 6, maxSpy = 2, curAtk=0,curSpy=0, lastSpyTime=0, lastAtkIdx=0, inMapAtk=0, tmpSkipFront = Array(false, false, false, false)
Dim gLastExeTowerNo=0, gLastExeTowerTime=0
Function autoAtk(spyMode)
    TracePrint "Start auto ack with " & gLastExeTowerNo
	
    //活动：B战
    If gBrmdEnable Then
    	campaignBerimond()
    End If
	
    //活动：刀锋
    //campaignBlade()
	
    ////////////////////////////////////////////////////////////////////////////////
	
    If gotoMainMap() Then 
        curMap = 0
    Else 
        TracePrint "跳转主视图失败。"
        Exit Function
    End If
	
    Delay DELAY_OPERATE_RANK(0)
	
    Dim atkSpy = readMovements()
	
    //6, 3
    curAtk = atkSpy(0)
    curSpy = atkSpy(1)
	
    //优先队列
    Dim result
	
    //============================================================
    //游牧活动，武士活动
    // gCampaignType控制 0：无，1：游牧，2：武士
    maxSpy = 1
    If IsNull(curCampaignTowerArray) = False Then
        campaignTask (curCampaignTowerArray)
        If gCampaignType = 1 Then 
        	Delay 10000
        	campaignTask (curCampaignTowerArray)
        End If
    End If

    //============================================================
    //普通图
    //
    maxSpy = 2
    //normal
    TracePrint Now() & " 执行普通队列.." & gLastExeTowerNo
    Dim changeMap = false
    lastAtkIdx = -1
	
    If gLastExeTowerNo > UBOUND(targetArray) Then 
    	//避免循环过快结束，导致主循环等待过长
    	If Time() - gLastExeTowerTime < 5 * MINUTE_ONE Then 
    		Dim dMinute = 5 * MINUTE_ONE - (Time() - gLastExeTowerTime)
    		
    		If gBuildArmyNum <> 0 or (gBuildArmy >= 2 And gBuildArmy <= 5) Then 
    			Dim tReSecond = gCityRecruitTimer*MINUTE_ONE - ( Time() - glastCityRecruitTime )
    			If tReSecond < dMinute Then 
    				dMinute = tReSecond
    			End If
    		End If
    		
    		TracePrint "Wait attack loop end: " & dMinute
    		Delay dMinute*1000
    	End If
    	gLastExeTowerTime = Time()
        gLastExeTowerNo = 0
        tmpSkipFront = Array(false, false, false, false)
    End If
	
	Dim tmpMap
    For index = gLastExeTowerNo To UBOUND(targetArray)
        gLastExeTowerNo = index + 1
		tmpMap = targetArray(index, TAGT_MAP) Mod 10
		
        If changeMap And curMap = tmpMap Then 
            //continue
        Elseif gSkipBrigandMap(tmpMap) = 1 or ( tmpMap=0 And tmpSkipFront(targetArray(index, TAGT_MAP)\10) = True)Then
        	//skip map by config
        	Delay 100
        Else
            changeMap = False
			
            result = atkLoopLogic(targetArray(index), spyMode)
            If result < 0 Then 
                TracePrint "Atk Loop Exit: " & result
                If result = -100022 or result=-100021 Then 
                    If tmpMap = 0 Then 
                    	tmpSkipFront(targetArray(index, TAGT_MAP)\10) = True
                    Else 
                    	changeMap = true
                    End If
                Else 
                    Exit For
                End If
            ElseIf result = 1 Then
                lastAtkIdx = index
                inMapAtk = inMapAtk + 1
                If inMapAtk >= 4 Then 
                    changeMap = true
                End If
            End If
        End If
		
        //避免过长时间
        Dim curTime = Time()
        If (curTime - gMainLoopStartTime > gTimer * MINUTE_ONE) or (curTime - gAtkLoopStartTime > gTimerPriority * MINUTE_ONE) Then 
            TracePrint Now() & "Break loop for gTimer or gTimerPriority."
            Exit For
        End If
        
        // for fast create
        //TracePrint curTime - glastCityRecruitTime
        If gRunCounter<>0 and gBuildArmyNum > 0 And curTime - glastCityRecruitTime > gCityRecruitTimer*MINUTE_ONE Then 
            TracePrint Now() & "Break loop for fast recruit."
            Exit For
        End If
    Next
	
	
    If curAtk >= maxAtk Then 
        autoAtk = 1
		
        //从最后一次攻击位置开始
        If lastAtkIdx <> -1 Then 
            gLastExeTowerNo = lastAtkIdx+1
        End If
    Else
        autoAtk = 0
    End If
End Function

Function atkLoopLogic(targetData, spyMode)
    Dim resultCode = 0
    If curSpy < 0 Then 
        curSpy = 0
    End If
		
	// map 0-n(n < 10), tower id 1x,2x...9x 
    Dim mapNo = targetData(TAGT_MAP)
    If mapNo >= 0 Then 
        if mapNo >= 10 then
			mapNo = mapNo Mod 10
		end if
		
		If mapNo <> curMap Then 
            if gotoWorldMap (mapNo) Then
                curMap = mapNo
                inMapAtk = 0
            Else 
                atkLoopLogic = -1
            End If
        End If
			
        Dim isAtk = true, isSpy=true
        If (targetData(TAGT_TYPE)<10 and curAtk >= maxAtk) or spyMode Then 
            isAtk = false
        End If
			
        //根据时间重置spy
        If Time() - lastSpyTime > 45 Then 
            curSpy = curSpy - 2
            lastSpyTime = Time()
        End If
			
        If curSpy >= maxSpy Then 
            isSpy = False
        End If
			
			
        If isAtk or isSpy Then 
            resultCode = dealOneTarget(targetData, isAtk, isSpy)
            //TracePrint "result : " & result
            //Dim result = 0
            If resultCode < 0 Then 
                If resultCode = -101 Then 
                    If isDisConnect() Then 
                        TracePrint "断开连接"
                    Else 
                        TracePrint "其他原因导致定位出错"
                        resultCode = 12
                    End If
                ElseIf resultCode = -100022 Then
                    //
                Else
                    TracePrint "退出循环,result:" & resultCode
                End If
            ElseIf resultCode = 12 Then
                lastSpyTime = Time()
                curSpy = curSpy + 1
            ElseIf resultCode = 1 Then
                curAtk = curAtk + 1
                If curSpy > 0 Then
                    lastSpyTime = Time()
                    curSpy = curSpy - 2
                End If
            ElseIf resultCode = 0 Then
                //重连退出
                //TracePrint "跳过"
                If isDisConnect() Then 
                    TracePrint "断开连接"
                    resultCode = -1
                End If
            End If
        Else 
            TracePrint "退出循环:" & curAtk & "," & curSpy
            resultCode = -1
        End If	
				
    End If
		
    //判断时间
    If Time() - gMainLoopStartTime > gTimer * MINUTE_ONE Then 
        TracePrint Now() & " Break attack Loop"
        resultCode = -1
    End If
        
    atkLoopLogic = resultCode
End Function

//46->137, 初试线以下（不含），文字框以上（不含）
// -10:not enough soldier， -11：not commander， 1：execute spy
//SPY: 10:cancle, 11:doing, 12:done
Function dealOneTarget(targetData, canAtk, canSpy)
    TracePrint Now() & " dealOneTarget: [" & CStr(canAtk)& "," & CStr(canSpy) & "], [" & Join(targetData, ",") & "]"
	
		
    //0: skip
    dealOneTarget = 0
	
    //attacking
    If targetData(TAGT_ATK) = 1 Then 
        //TracePrint "跳过执行： already atacking. "
        Exit Function
    End If
	
    //cooldown & spied => skip
    Dim curTime = Time()
    If targetData(TAGT_SPY) = 15 And curTime < targetData(TAGT_ATK_T) Then 
        //TracePrint "跳过执行：spy = 15 and atk not cool down"
        Exit Function
    End If
	
    //no atack times and alread spy => skip
    If targetData(TAGT_SPY) = 15 and not(canAtk) Then 
        //TracePrint "跳过执行：spy=15, can not atk times"
        Exit Function
    End If
	
	
    //can not spy and none spy （0：init，10：not spy）
    If not (canSpy) And targetData(TAGT_SPY) = 10 Then 
        //TracePrint "跳过执行：x:" & targetData(TAGT_X) & ",y:" & targetData(TAGT_Y)  
        Exit Function
    End If
	
    //正在执行spy
    If targetData(TAGT_SPY) = 12 And Time() < targetData(TAGT_SPY_T) Then 
        //执行中
        Exit Function
    End If
	
    //正在执行Atk
    If targetData(TAGT_ATK) = 2 And curTime < targetData(TAGT_ATK_T) Then 
        //TracePrint "执行任务中……"
        Exit Function
    End If
	
    clearPopWindow 
    
    //verify map
    If targetData(TAGT_MAP) Mod 10 = 0 Then 
    	FindPic( 0, 0, 0, 0, "Attachment:map_grass_flag.png|Attachment:map_flag_grass_snow.png", "000000", 0, 1, intX, intY)
    	If intX = -1 Then 
    		TracePrint "ERROR: fail to verify map. not find grass flag."
    		Exit Function
    	End If
    ElseIf targetData(TAGT_MAP) = 1 Then
    	FindPic( 0, 0, 0, 0, "Attachment:map_flag_ice.png|Attachment:map_flag_ice2.png|Attachment:map_flag_ice3.png", "000000", 0, 0.9, intX, intY)
    	If intX = -1 Then 
    		TracePrint "ERROR: fail to verify map. not find ice flag."
    		Exit Function
    	End If
    ElseIf targetData(TAGT_MAP) Mod 10 Then
    	FindPic( 0, 0, 0, 0, "Attachment:map_grass_flag.png|Attachment:map_flag_grass_snow.png", "000000", 0, 1, intX, intY)
    	If intX > -1 Then 
    		TracePrint "ERROR: fail to verify map. find grass flag." & targetData(TAGT_MAP)
    		Exit Function
    	End If
    End If

    result = selectTarget(targetData(TAGT_X), targetData(TAGT_Y))
    If result = -1 Then 
        TracePrint "无法输入，退出执行"
        dealOneTarget = -101
        Exit Function
    End If
	
    Delay DELAY_OPERATE_RANK(1)
	
    //verify position
    Dim realX = Cint(EmpireOcr.ocrNumber(30, 61, 70,70))
    Dim realY = Cint(EmpireOcr.ocrNumber(130, 61, 170,70))
    If targetData(TAGT_X) <> realX or targetData(TAGT_Y) <> realY Then 
        TracePrint "定位错误：" & realX & "," & realY
        dealOneTarget = 100101
        Exit Function
    End If
	
	
    Dim result = readBase()
    If result = -1 Then 
        TracePrint "无法获取基准点，退出执行"
        dealOneTarget = -101
        Exit Function
    End If
	
    //获取级别
    If targetData(TAGT_LVL) = 0 And targetData(TAGT_TYPE) < 10 Then
        Dim level = readLevel(baseX, baseY)
        //TracePrint "级别"&level
		
        targetData(TAGT_LVL) = CInt(level)
    End If
	
    //侦查 12:done, 11:doing, 10 cancle
    spyTarget(baseX, baseY, targetData, canSpy)
    TracePrint "Spy result: " & Join(targetData, ",") & "]"
    If targetData(TAGT_SPY) <> 15 Then 
        dealOneTarget = targetData(TAGT_SPY)
        Exit Function
    End If
	
    //攻击
    If canAtk Then
        dealOneTarget = attackTarget(baseX, baseY, targetData)
        TracePrint "Atk result: " & Join(targetData, ",") & "]"
    End If
End Function

Dim lastTransportTime = 0
Function transportGoods
    If gTranEnable = False Then 
    	Exit Function
    End If
    
    If Time() - lastTransportTime < 10 * MINUTE_ONE Then 
        Exit Function
    End If
    lastTransportTime = Time()
	
    TracePrint Now() & " Transport..."
    clearPopWindow()
	
    tapPosition 464, 750
    Delay DELAY_OPERATE_RANK(1)
	
    Dim result
    result = tapPic2(Array("Attachment:banner_manage.png", "Attachment:banner_m_economic.png"), DELAY_OPERATE_RANK(1))
    If result = False Then 
        TracePrint "无法跳转到经济面板"
        Exit Function
    End If
	
    Dim data = Array(4)
	
    For i = 0 To 3
        Delay DELAY_OPERATE_RANK(1)
        FindPicArea2(0, 277, screenX, 309, "Attachment:mark_city_src_" & i & ".png")
        If intX = -1 or intY = -1 Then 
            TracePrint "验证源失败：" & i
            Exit Function
        End If
		
        data(i) = readGoods()
        If data(i, 2) = 0 Then 
            TracePrint "读取数据失败"
            Exit Function
        End If
		
        If i <> 3 Then
            If tapPic("Attachment:op_move_goto_right.png") = False Then 
                TracePrint "右跳转失败"
                Exit Function
            End If
        End If
    Next
	
    TracePrint "data:" & CommUtil.Join2DimArray(data)
	
    //clearPopWindow
    Dim fromCity = 2, thresholdOut = 50000, thresholdIn = 70000
    If data(fromCity, 0) > thresholdOut or data(fromCity, 1) > thresholdOut or data(fromCity, 2) > thresholdOut Then 
		
		//toCity<> 3 and
        For toCity = 3 To 0 step -1
            If toCity <> fromCity and _
			( (data(fromCity, 0)>thresholdOut and data(toCity, 0) < thresholdIn) _
			or (data(fromCity, 1)>thresholdOut and data(toCity, 1) < thresholdIn) _
			or ((toCity=0 or data(0,2)>60000 or data(toCity,2)<15000) and data(fromCity, 2)>(thresholdOut+10000) and data(toCity, 2) < thresholdIn)) Then 
				
                FindPicArea2(0, 277, screenX, 309, "Attachment:mark_city_src_" & toCity & ".png")
                If intX = -1 or intY = -1 Then 
                    TracePrint "验证目标失败：" & toCity
                    Exit Function
                End If
				
                If tapPic("Attachment:op_move_transport.png") = False Then 
                    TracePrint "search toCity:" & toCity
                    Exit Function
                End If
				
                actionConfirm 
				
                Dim startX = 37
                For i = 0 To 2
					
                    Dim img =  "Attachment:mark_city_from_" & fromCity & ".png"
                    Delay DELAY_OPERATE_RANK(1)
                    FindPicArea2(startX,288,239,320, img)
                    //TracePrint img & "=>" & intX & "," & intY
                    If intX > 0 And intY > 0 Then 
                        Dim startY=0
                        If data(fromCity, 0)>thresholdOut and data(toCity, 0) < thresholdIn Then 
                            startY=350
                        ElseIf data(fromCity, 1)>thresholdOut and data(toCity, 1) < thresholdIn Then
                            startY=432
                        ElseIf (toCity=0 or data(0,2)>60000) and data(fromCity, 2)>thresholdOut and data(toCity, 2) < thresholdIn Then
                            startY=514
                        Else 
                            TracePrint "no transport"
                            Exit Function
                        End If
						
                        If startY > 0 Then
                            FindPicArea2 startX, startY, 64, startY + 50, "Attachment:op_move_select_startpoint.png"
                            If intX > 0 And intY > 0 Then 
                                tapPosition(intX+381, intY+7)
                            Else 
                                TracePrint "not find operate_select_startpoint"
                            End If
							
                            actionConfirm 
                            actionConfirm
							
                            TracePrint "传输："& fromCity & "=>" & toCity
                            Exit Function
                        End If
                    Else 
                        tapPicArea(startX, 288, 239, 320, "Attachment:op_move_goto_right.png", DELAY_OPERATE_RANK(1))
                    End If
                Next
				
                actionCancle()
            End If
			

            If tapPicArea(startX, 277, screenX, 310, "Attachment:op_move_goto_left.png", DELAY_OPERATE_RANK(1)) = False Then 
                TracePrint "左跳转失败"
                Exit Function
            End If
            Delay DELAY_OPERATE_RANK(1)
        Next
    End If

    clearPopWindow
    Delay DELAY_OPERATE_RANK(2)
End Function
Function readGoods()	
    Dim positionArray = Array(3)
    positionArray(0) = Array(44,347)
    positionArray(1) = Array(44,381)
    positionArray(2) = Array(44,413)
	
    CommUtil.capKeepMem(0)
    Dim result = Array(UBound(positionArray)+1)
    For i = 0 To UBound(positionArray)
        result(i) = readGoodsOne(positionArray(i, 0), positionArray(i, 1), -(i mod 2))
    Next
    CommUtil.capRealseMem
	
    readGoods = result
End Function
Function readGoodsOne(px, py, ex)
    readGoodsOne = CInt(EmpireOcr.ocrNumber(px+55,py+9+ex,px+101, py+17+ex))
End Function

Function readMovements
    TracePrint Now() & " Read All Trops Action..."
    readMovements = Array(0, 0)
	
    Delay DELAY_OPERATE_RANK(0)
    tapPosition 464, 750
    Delay DELAY_OPERATE_RANK(1)
	
    FindPicFull "Attachment:banner_manage.png"
    If intX = -1 or intY = -1 Then 
        TracePrint "找不到管理图标"
        Exit Function
    End If
	
    Tap intX+10, intY+10
    Delay DELAY_OPERATE_RANK(0)
	
    FindPicFull "Attachment:banner_m_move.png"
    If intX = -1 or intY = -1 Then 
        TracePrint "找不到移动图标"
        Exit Function
    End If
	
    Tap intX + 10, intY + 10
    Delay DELAY_OPERATE_RANK(1)
	
	
    FindPicFull "Attachment:p_activity_tab_military.png"
    If intX = -1 or intY = -1 Then 
        TracePrint "找不到p_activity_tab_military图标"
        Exit Function
    End If
	
    tapPosition intX + 10, intY + 10
    Delay DELAY_OPERATE_RANK(0)
		
    //X: 17,4, 46,13 Y: 64,4, 94,13
    //type icon -10,350    21,390
    Dim atkCount = 0, spyCount=0, timeStr, timeInS
    Dim startX=0,startY=0, basicX, basicY, px, py
    TracePrint Now() & " Read Attacking Data..."
	
    CommUtil.capKeepMem(0)
    Do While True
        FindPicArea(startX, startY, "Attachment:p_activity_coordinate_x.png")
        If intX = -1 or intY = -1 Then 
            //TracePrint "查找结束"
            Exit Do
        End If
		
        atkCount = atkCount+1
        startY = intY + 50
		
        basicX = intX
        basicY = intY
		
        px = CInt(EmpireOcr.ocrNumber(basicX+17, basicY+4, basicX+46, basicY+13))
        py = CInt(EmpireOcr.ocrNumber(basicX+64, basicY+4, basicX+94, basicY+13))
		
        timeStr = EmpireOcr.ocrNumber2(basicX+240, basicY+68, basicX+300, basicY+79,1)
        timeInS = CommUtil.formatTime(timeStr)
        If timeInS = 0 Then 
            timeInS = 60 * MINUTE_ONE
        End If
		
        Dim land = FindPicArea2(basicX+350, basicY-10, basicX+390, basicY+24, "Attachment:p_activity_land_0.png|Attachment:p_activity_land_1.png")
        TracePrint "Attacking: [" & px & "," & py & "]-" & land & ", " & timeStr
		
        If px <> 0 And py <> 0 Then 
            For i = 0 To UBOUND(targetArray)
                If targetArray(i, TAGT_X) = px And targetArray(i, TAGT_Y) = py Then 
                    If targetArray(i, TAGT_ATK) = 0 Then
                        //设置为正在attack
                        TracePrint "Update Attack Status"
                        targetArray(i, TAGT_ATK) = 2
                        targetArray(i, TAGT_ATK_T) = Time() + timeInS
                    End If
					
                    Exit For
                End If
            Next
			
            If IsNull(curCampaignTowerArray) = False Then
                For i = 0 To UBOUND(curCampaignTowerArray)
                    If curCampaignTowerArray(i, TAGT_X) = px And curCampaignTowerArray(i, TAGT_Y) = py Then 
                        If curCampaignTowerArray(i, TAGT_ATK) = 0 Then
                            //设置为正在attack
                            TracePrint "Update Attack Status"
                            curCampaignTowerArray(i, TAGT_ATK) = 2
                            curCampaignTowerArray(i, TAGT_ATK_T) = Time() + timeInS
                        End If
						
                        Exit For
                    End If
                Next
            End If
        Else
            TracePrint "OCR Movement Failed: " & px & "," & py
        End If
    Loop
    CommUtil.capRealseMem
	
    readMovements = Array(atkCount, 0)
	
    TracePrint Now() & " Read Spying Data..."
    FindPicFull "Attachment:p_activity_tab_spy.png"
    If intX = -1 or intY = -1 Then 
        TracePrint "找不到p_activity_tab_spy图标"
        Exit Function
    End If
	
    tapPosition intX + 10, intY + 10
    Delay DELAY_OPERATE_RANK(0)
	
    startX = 0
    startY = 0
	
    CommUtil.capKeepMem(0)
    Do While True
        FindPicArea(startX, startY, "Attachment:p_activity_coordinate_x.png")
        If intX = -1 or intY = -1 Then 
            //TracePrint "查找结束"
            Exit Do
        End If
		
        spyCount = spyCount + 1
        startY = intY + 50
        basicX = intX
        basicY = intY
		
        TracePrint "OCR X: " & basicX & "," & basicY
        px = CInt(EmpireOcr.ocrNumber(basicX+17, basicY+2, basicX+46, basicY+13))
        py = CInt(EmpireOcr.ocrNumber(basicX+64, basicY+2, basicX+94, basicY+13))
		
        timeStr = EmpireOcr.ocrNumber2(basicX+240, basicY+80, basicX+310, basicY+93,1)
        timeInS = CommUtil.formatTime(timeStr)
        If timeInS = 0 Then 
            timeInS = 5 * MINUTE_ONE
        End If
		
        land = FindPicArea2(basicX + 340, basicY - 20, basicX + 400, basicY + 24, "Attachment:p_activity_land_0.png|Attachment:p_activity_land_1.png")
        //land = FindPicFull("Attachment:move_land1.png|Attachment:move_land2.png")
        TracePrint "Spying : [" & px & "," & py & "]-" & land & ", " & timeStr
		
        For i = 0 To UBOUND(targetArray)
            If targetArray(i, TAGT_X) = px And targetArray(i, TAGT_Y) = py Then 
                If targetArray(i, TAGT_SPY) = 0 Then
                    //设置为正在spy
                    TracePrint "Update Spying Status"
                    targetArray(i, TAGT_SPY) = 12
                    targetArray(i, TAGT_SPY_T) = Time() + timeInS
                End If
				
                Exit For
            End If
        Next
    Loop
    CommUtil.capRealseMem
	
    readMovements = Array(atkCount, spyCount)
End Function

////map_no, x, y, type(1:tufei，2youmu), spy(0,1,2), spy_time attack(0,1,2), attack_time
Function attackTarget(baseX, baseY, targetData)
    TracePrint Now() & " Attack target: [" & Join(targetData, ",") & "]"
	
    attackTarget = 0
    If targetData(TAGT_SPY) <> 15 Then 
        Exit Function
    End If
	
	
    //状态：2进行中，5冷却中
    Dim curTime = Time()
    //状态为5，时间在冷却时间内
    If targetData(TAGT_ATK) = 5 And curTime < targetData(TAGT_ATK_T) Then 
        TracePrint "冷却中……"
        Exit Function
    End If
	
    //正在attack:状态为2，时间在攻击时间内【】
    If targetData(TAGT_ATK) = 2 And curTime < targetData(TAGT_ATK_T) Then 
        TracePrint "执行任务中……"
        Exit Function
    End If
	
    tapPosition(baseX, baseY)
	
    //判断是否在冷却
    FindPicFull "Attachment:bat_cooldown.png"
    If intX > -1 and intY > -1 Then 
        //冷却中，修改状态
        //读取时间224, 387, 370, 395
        TracePrint "冷却确认……"
        Dim timeStr = EmpireOcr.ocrNumber(224, 385, 270, 395)
        targetData(TAGT_ATK) = 5
		
        Dim coolTime = CommUtil.formatTime(timeStr)
        	
        //冷却修复
        Dim flag = false
        If targetData(TAGT_TYPE) = 11 And targetData(TAGT_LVL) = 91 Then 
        	TracePrint "==" & coolTime
        	if tapPicArea(0, 300, screenY, 500,"Attachment:bat_cd_refresh.png", DELAY_OPERATE_RANK(1)) Then
        		Dim moveFlag30m=false,moveFlag10m=false, moveFlag5m=false
        		Delay DELAY_OPERATE_RANK(2)
        		For n = 1 To cdExeTimes
        			If (cdToolsEnable(0)=True and n=1) And coolTime > cdToolsTime(0) Then 
        				FindPicArea2 0, 300, screenY, 500, "Attachment:bat_cd_refresh_24h.png|Attachment:bat_cd_refresh_24h_1.png"
        				TracePrint "find cd 24h =>" & intX & "," & intY
        				If intX > -1 Then 
        					tapPosition intX, intY + 100
        					coolTime = coolTime - 36000
        				End If
        			ElseIf (cdToolsEnable(1)=True And n=1) and coolTime > cdToolsTime(1) Then 
        				FindPicArea2 0, 300, screenY, 500, "Attachment:bat_cd_refresh_5h.png|Attachment:bat_cd_refresh_5h_1.png"
        				TracePrint "find cd 5h =>" & intX & "," & intY
        				If intX > -1 Then 
        					tapPosition intX, intY + 100
        					coolTime = coolTime - 18000
        				End If
        			ElseIf cdToolsEnable(2)=True and coolTime > cdToolsTime(2) Then
        				FindPicArea2 0, 300, screenY, 500, "Attachment:bat_cd_refresh_1h.png|Attachment:bat_cd_refresh_1h_1.png"
        				TracePrint "find cd 1h =>" & intX & "," & intY
        				If intX > -1 Then 
        					tapPosition intX, intY + 100
        					coolTime = coolTime - 3600
        				Else 
        					tapPosition 40, 420
        					cdToolsEnable(2) = False
        					Delay DELAY_OPERATE_RANK(1)
        				End If
        			ElseIf cdToolsEnable(3)=true And coolTime>cdToolsTime(3) Then
        				FindPicArea2 0, 300, screenY, 500, "Attachment:bat_cd_refresh_30m.png|Attachment:bat_cd_refresh_30m_1.png"
        				TracePrint "find cd 30m =>" & intX & "," & intY
        				If intX > -1 Then 
        					tapPosition intX, intY + 100
        					coolTime = coolTime - 1800
        				ElseIf moveFlag30m = False Then
        					tapPosition 40, 420
        					moveFlag30m = true
        					Delay DELAY_OPERATE_RANK(1)
        				Else 
        					cdToolsEnable(3) = False
        				End If
        			ElseIf cdToolsEnable(4)=True and coolTime > cdToolsTime(4) Then
        				FindPicArea2 0, 300, screenY, 500, "Attachment:bat_cd_refresh_10m.png|Attachment:bat_cd_refresh_10m_1.png"
        				TracePrint "find cd 10m =>" & intX & "," & intY
        				If intX > -1 Then 
        					tapPosition intX, intY + 100
        					coolTime = coolTime - 600
        				ElseIf moveFlag10m = False Then
        					tapPosition 40, 420
        					moveFlag10m = true
        					Delay DELAY_OPERATE_RANK(1)
        				Else 
        					cdToolsEnable(4) = False
        					//Delay DELAY_OPERATE_RANK(1)
        				End If
        			Else
        				FindPicArea2 0, 300, screenY, 500, "Attachment:bat_cd_refresh_5m.png|Attachment:bat_cd_refresh_5m_1.png"
        				TracePrint "find cd 5m =>" & intX & "," & intY
        				If intX > -1 Then 
        					tapPosition intX, intY + 100
        					coolTime = coolTime - 300
        				ElseIf moveFlag5m = False Then
        					tapPosition 40, 420
        					moveFlag5m = true
        					Delay DELAY_OPERATE_RANK(1)
        				End If
        			End If
        			
        			If coolTime <= 0 Then 
        				Exit For
        			Else 
        				Delay DELAY_OPERATE_RANK(2)
        			End If
        		Next
        	End If
        	
        	Delay DELAY_OPERATE_RANK(2)
        	FindPicArea2 0, 300, screenY, 600, "Attachment:op_cancle.png"
        	If intX > -1 Then 
        		flag = True
        	Else 
        		coolTime = 300
        	End If
        	
         End If
          
        If flag = False Then 
        	targetData(TAGT_ATK_T) = Time() + coolTime
        	TracePrint "Cooldown target: [" & Join(targetData, ",") & "]" & coolTime
        	Exit Function	
        End If
    End If
	
    //发起位置确认
	Dim atkTowerNo = targetData(TAGT_MAP) \ 10
    If atkTowerNo > 0 Then
        For i = 1 To atkTowerNo
            If tapPicArea(43, 437, 244, 469, "Attachment:op_move_goto_right.png", DELAY_OPERATE_RANK(0)) = False Then 
                attackTarget = -1
                Exit Function
            End If
        Next
        //tapPosition 55,452
    End If
	
    actionConfirm()
    Delay DELAY_OPERATE_RANK(2)
	
    //获取数据
	/*
	Dim allTargetInfo = readAllEnimyCity(targetData(TAGT_TYPE))
	TracePrint "对方信息："& CommUtil.Join2DimArray(allTargetInfo)
	If allTargetInfo(0, 0) = -1 Then 
		TracePrint "数据异常，退出"
		Exit Function
	End If
	*/
	
    Dim result
    Dim allAttackData = Array(3)
    allAttackData(SIDE_CENTER) = Array(false, 0)
    allAttackData(SIDE_LEFT) = Array(false, 0)
    allAttackData(SIDE_RIGHT) = Array(false, 0)
    
    If targetData(TAGT_TYPE) = 11 Then 
        result = atkNomads(targetData, allAttackData) 
    ElseIf targetData(TAGT_TYPE) = 12 Then
        result = atkSamurai(targetData)
    Else 
        result = atkBrigands(targetData, allAttackData)
    End If
	
    If result < 0 Then 
    	TracePrint "[WARN] fail to build attack data."
    	attackTarget = result
    	Exit Function
    End If
    
    result = atkSideTurn(allAttackData)
    attackTarget = result
	
    //ready for battle
    If result = 1 Then 
        //DO
        FindPicFull "Attachment:bat_attack_start.png"
        TracePrint Now() & "Attack X, Y: " & intX & "," & intY
        If intX > -1 and intY > -1 Then 
            tapPosition intX + 5, intY + 5
			
            //read time
            Dim atkTimeStr = EmpireOcr.ocrNumber2(230, 192, 285, 205, 2)
            actionConfirm
			
            Dim atkIimeInS = CommUtil.formatTime(atkTimeStr)
            If atkIimeInS = 0 Then 
                TracePrint "[ERROR] can not read attack time. " & Now()
                If targetData(TAGT_TYPE) = 11 Then 
                	atkIimeInS = 9 * 60
                Else 
                	atkIimeInS = 60 * 60
                End If
            End If
			
            targetData(TAGT_ATK) = 2
            targetData(TAGT_ATK_T) = Time() + atkIimeInS
			
            targetData(TAGT_SPY) = 10
        Else 
            attackTarget = 0
        End If
    End If
	
End Function


//============================================================================================
// allAttackData(0,1,2): SIDE_CENTER, SIDE_LEFT, SIDE_RIGHT
// attackAllocateAll(atkArgs, atkSideData, atkBaseData, atkToolData)
//============================================================================================
Dim ATK_DATA_FLAG=0, ATK_DATA_ARGS=1, ATK_DATA_TOOL=2, ATK_DATA_DEF=3, ATK_DATA_BASE=4
Function atkSideTurn(allAttackData)
	Dim result = 0
	
	Delay DELAY_OPERATE_RANK(1)
	If allAttackData(SIDE_CENTER, ATK_DATA_FLAG) Then 
		result = attackAllocateAll(allAttackData(SIDE_CENTER))
    	If result <= 0 Then 
        	atkSideTurn = result
        	Exit Function
    	Else 
        	atkSideTurn = 1
    	End If
	End If
	
	//LEFT
	If allAttackData(SIDE_LEFT, ATK_DATA_FLAG) Then 
		result = PictureUtil.tapPicRegion(PictureUtil.getRegion(4, 1), "Attachment:battle_face_left.png", DELAY_OPERATE_RANK(1))
		If result = False Then 
			atkSideTurn = -1
			TracePrint "[ERROR] "
		End If
		
		result = attackAllocateAll(allAttackData(SIDE_LEFT))
    	If result <= 0 Then 
        	atkSideTurn = result
        	Exit Function
    	Else 
        	atkSideTurn = 1
    	End If
		
		result = PictureUtil.tapPicRegion(PictureUtil.getRegion(4, 2), "Attachment:battle_face_right.png", DELAY_OPERATE_RANK(1))
		If result = False Then 
			atkSideTurn = -1
			TracePrint "[ERROR] "
		End If
		
	End If
	
	//LEFT
	If allAttackData(SIDE_RIGHT, ATK_DATA_FLAG) Then 
		result = PictureUtil.tapPicRegion(PictureUtil.getRegion(4, 2), "Attachment:battle_face_right.png", DELAY_OPERATE_RANK(1))
		If result = False Then 
			atkSideTurn = -1
			TracePrint "[ERROR] "
		End If
		
		result = attackAllocateAll(allAttackData(SIDE_RIGHT))
    	If result <= 0 Then 
        	atkSideTurn = result
        	Exit Function
    	Else 
        	atkSideTurn = 1
    	End If
	End If
End Function


//============================================================================================
// atkArgs : 
// ATK_DATA_CUR: attack side defence data, ATK_DATA_BASE: Base side defence data
// ATK_TOOL_DATA: attack tools data 2 Dimention
// Dim ATK_DATA_FLAG=0, ATK_DATA_ARGS=1, ATK_DATA_TOOL=2, ATK_DATA_DEF=3, ATK_DATA_BASE=4
//============================================================================================
Dim ATK_TYPE=0, ATK_SIDE_IDX=1, ATK_FODDER_TURNS=2, ATK_TURNS=3, ATK_TOOL_TURNS=4, ATK_TOOL_EXTRA=5
Function attackAllocateAll(attackData)
    
    Dim atkArgs = attackData(ATK_DATA_ARGS), atkSideData = attackData(ATK_DATA_DEF), atkBaseData = attackData(ATK_DATA_BASE), atkToolData = attackData(ATK_DATA_TOOL)
    Dim tmpToolTimes = 0, sltResult=-1, amountArray, total, defData
    attackAllocateAll = 0
	
	TracePrint "[attackAllocateAll]attack arguments:" & Join(atkArgs, ",")
	TracePrint "[attackAllocateAll]attack side defence: " & Join(atkSideData, ",")
	TracePrint "[attackAllocateAll]basic side defence: " & Join(atkBaseData, ",")
	TracePrint "[attackAllocateAll]tools data: " & CommUtil.Join3DimArray(atkToolData)
	
	//atk value is less
    If atkSideData(DF_PW_SHORT) + atkSideData(DF_PW_LONG) = 0 AND atkArgs(ATK_TOOL_EXTRA) = False Then 
        atkArgs(ATK_FODDER_TURNS) = 0
        atkArgs(ATK_TOOL_TURNS) = 0
        TracePrint "fix fodder and tools to zero."
    End If
	
    Delay DELAY_OPERATE_RANK(0) 
    For i = 1 To 4
        Dim resultIdx = PictureUtil.FindPicHalfBottom(atkWavesMark(i-1), intXY)
        If resultIdx <> -1 Then 
            Dim tmpX=intXY(X), tmpY=intXY(Y)
            If i = 1 Then 
                amountArray = readAtkNumber(tmpX, tmpY, atkArgs(ATK_SIDE_IDX))
                //TracePrint "attack pre count:" & Join(amountArray, ",")
            End If
			
            //转换初始点
            If atkArgs(ATK_SIDE_IDX) = SIDE_CENTER Then 
                tmpX = tmpX - 50
            Else 
                tmpX = tmpX - 15
            End If
			
            If atkArgs(ATK_FODDER_TURNS) >= i Then 
                sltResult = selectCannonSoldier(tmpX, tmpY)
                //TracePrint "Select soldier (cannon) " & sltResult
                If sltResult = 0 Then 
                    TracePrint "not cannon soldier: " & sltResult
                    sltResult = -100021
                    Exit For
                End If
            ElseIf atkArgs(ATK_TURNS)+atkArgs(ATK_FODDER_TURNS) >= i Then
                //tapPosition intX, intY + 80
				
                //base (targetType < 10 and i - cannonSoldier > 1) or (targetType >= 10 and (i - cannonSoldier) Mod 2 = 0)
                Dim realAtkNo = i - atkArgs(ATK_FODDER_TURNS)
                If (atkSideData(DF_PW_SHORT) + atkSideData(DF_PW_LONG) = 0) or (atkArgs(ATK_TYPE) < 10 and realAtkNo > 1) or (atkArgs(ATK_TYPE)>=10 and realAtkNo Mod 2 = 0)Then 
                    defData = atkBaseData
                Else 
                    defData = atkSideData
                End If
				
                //TracePrint Now() & " Enemy info " & Join(defData, ",")
                total = amountArray(0)
                sltResult = selectAtkSoldier(tmpX, tmpY, defData, total)
                TracePrint "Select soldier (attack) " & sltResult
                
                If sltResult < (total - total \ 10) Then 
                    TracePrint "not enough soldier: " & sltResult
                    sltResult = -100022
                    Exit For
                End If
				
				
				
                //wuqi
                If tmpToolTimes < atkArgs(ATK_TOOL_TURNS)  Then 
                    //wall
                    Dim sltToolResult = selectCommonTools(tmpX, tmpY, atkToolData(tmpToolTimes))
					
					TracePrint "Select soldier (tools) " & sltToolResult
                    If sltToolResult < 0 Then 
                        sltResult = sltToolResult
                        Exit For                
                    End If
					
                    tmpToolTimes = tmpToolTimes+1
                End If
            End If
			
			
            If atkArgs(ATK_TURNS) + atkArgs(ATK_FODDER_TURNS) <= i Then 
                Exit For
            End If
			
			
            //side:150, cener:220
            Delay DELAY_OPERATE_RANK(0)
            If atkArgs(ATK_SIDE_IDX) = SIDE_CENTER Then
				
                dragMove 370, 515, -220, 0
                If i= 3 Then
                    Delay DELAY_OPERATE_RANK(1)
                End If
            Else 
                If i < 3 Then
                    dragMove 370, 515, -150, 0
                End If
            End If
            Delay DELAY_OPERATE_RANK(1)
        Else 
            TracePrint "找不到波次:" & i & "," & atkWavesMark(i-1)
            sltResult = -20
            Exit For
        End If
    Next
	
    attackAllocateAll = sltResult
End Function

//============================================================================================
// toolsInfo: 1-3 dimention, TYPE:string, CNT:int, MODE:int
//============================================================================================
Dim TINFO_CNT=0, TINFO_TYPE=1, TINFO_MODE=2
Function selectCommonTools(px, py, toolsInfo)
    //BaseX, BaseY+160
    TracePrint "[selectCommonTools]: " & CommUtil.Join2DimArray(toolsInfo)
    selectCommonTools = 0
    
    Dim resultNum = Array(3), maxIdx = -1
    For i = 0 To UBound(toolsInfo)
    	If IsArray(toolsInfo(i)) Then 
    		maxIdx = i
    	Else 
    		Exit For
    	End If
    Next
    
    If maxIdx = -1 Then 
    	TracePrint "[WARN] no tool plan. "
    	Exit Function
    End If
	
    For i = 0 To maxIdx
        If toolsInfo(i, TINFO_CNT) > 0 Then   
        	Dim mode = 5
        	If UBOUND(toolsInfo(i)) = 2 Then 
            	mode = toolsInfo(i,2)
        	End If
			
        	Dim realNum = selectSoldierNum(px+i*68, py+181, toolsInfo(i,TINFO_TYPE), mode, toolsInfo(i,TINFO_CNT), false)
        	If realNum <  toolsInfo(i, TINFO_CNT) and UBOUND(toolsInfo(i)) < 2 Then
            	TracePrint "not enough tools: " & realNum
            	selectCommonTools = -100023
            	Exit For
        	Else 
            	resultNum(i) = realNum
        	End If
        End If
    Next
	
    //verify tools
    Dim actTools = readActualTools(px, py, maxIdx+1)
    For i = 0 To maxIdx
        If (actTools(i) < toolsInfo(i, TINFO_CNT) And UBOUND(toolsInfo(i)) < 2) or (actTools(i)=0 and toolsInfo(i, TINFO_CNT)<>0) Then 
			
            TracePrint "invalid tools amount: " & actTools(i) & "," & toolsInfo(i, TINFO_CNT)
            selectCommonTools = -100024
            Exit For
        ElseIf  actTools(i) > toolsInfo(i, TINFO_CNT) Then
            TracePrint "invalid tools amount: " & actTools(i) & "," & toolsInfo(i, TINFO_CNT)
        End If
    Next
End Function

Dim gCampaignLastTime=0
Function campaignTask(campaignArray)
    Dim priorityAtkCount = 0, result
    If gLastExePriorityNo > UBOUND(campaignArray) Then 
        gLastExePriorityNo = 0
    End If
	
	/*
	If Time() - gCampaignLastTime < gCampaignMinTimer*MINUTE_ONE Then 
		TracePrint "没有达到最小间隔时间"
		Exit Function
	End If
	*/
    gCampaignLastTime = Time()
	
    TracePrint Now() & " 执行优先队列.." & gLastExePriorityNo
	
    Dim curTime = Time()
    If gFastCampaingFlag > 0 Then 
    	curTime = Time()
    Else 
    	For index = 0 To UBOUND(campaignArray)
        	If campaignArray(index, TAGT_ATK) = 2 And curTime < campaignArray(index, TAGT_ATK_T) Then 
            	priorityAtkCount = priorityAtkCount+1
        	End If
    	Next
    End If

	
    Dim startSpy = false
	
    TracePrint "Start Priority: " & priorityAtkCount & ",count:" & UBOUND(campaignArray)
    For index = gLastExePriorityNo To UBOUND(campaignArray)
        If priorityAtkCount >= 2 Then 
            TracePrint "超过最大并发"
            startSpy = true
        End If
		
        //max 2lu
        result = atkLoopLogic(campaignArray(index), startSpy)
        If result < 0 Then 
            gLastExePriorityNo = index
            TracePrint "活动队列出错：" & result
            //Exit For
        ElseIf result = 1 Then
            If campaignArray(index, TAGT_ATK) = 2 Then 
                priorityAtkCount = priorityAtkCount + 1
            End If
        End If
		
        gLastExePriorityNo = index + 1
    Next
End Function

Dim lastBladeDealTime = 0
Function campaignBlade
    If lastBladeDealTime = 0 Then 
        lastBladeDealTime = Time()
        Exit Function
    End If
    
    If Time() - lastBladeDealTime < 20 * MINUTE_ONE Then 
        Exit Function
    End If
    lastBladeDealTime = Time()
    
    if tapPic("Attachment:banner_navigate.png") = False Then
        TracePrint "找不到导航图标"
        Exit Function
    End If
    Delay DELAY_OPERATE_RANK(0)

    If tapPic("Attachment:menu_nav_blade.png") = False Then 
        TracePrint "找不到刀锋图标"
        Exit Function
    End If
	
    tapPosition 200, 380
    waitLoadingPage()
	
    FindPicFull "Attachment:blade_mark.png"
    If intX = -1 or intY = -1 Then 
        TracePrint "没有进入刀锋"
        Exit Function
    End If
	
    ////////////////////////////////////////////////////
	
	
	
    ////////////////////////////////////////////////////
	
    tapPic2(Array("Attachment:banner_navigate.png", "Attachment:menu_nav_camp.png"), DELAY_OPERATE_RANK(1))
    waitLoadingPage()
    buildRoom(2)
    gotoMainMap()
    ////////////////////////////////////////////////////
	
End Function
Function buildBlade
	
End Function
Function atkBladePlan
    Dim startX = 0, startY = 0
    Do While True
        FindPicArea startX, startY, "Attachment:blade_boat_1.png|Attachment:blade_boat_2.png"
        If intX = -1 or intY = -1 Then 
            Exit Do
        End If
	
        startY = intY + 4
        tapPosition intX, intY
		
        If readBase() <> -1 Then 
            tapPosition baseX, baseY
            Dim result = atkBlade() 
			
            If result >= 0 Then 
                //DO
                FindPicFull "Attachment:bat_attack_start.png"
                TracePrint Now() & "Attack X, Y: " & intX & "," & intY
                If intX > -1 and intY > -1 Then 
                    tapPosition intX + 5, intY + 5
                    Delay DELAY_OPERATE_RANK(0) 
                    actionConfirm
                End If
            End If
        End If
    Loop
End Function

Function atkBlade
    Dim allTargetInfo = readAllEnimyCity(16)
    If allTargetInfo(0, 0) <= 0 or allTargetInfo(1, 0) <= 0 or allTargetInfo(2, 0) <= 0 Then 
        TracePrint "数据异常，退出"
        atkBlade = -1
        Exit Function
    End If
	
	
	
	
End Function

Dim lastBerimondExeTime = 0
Function campaignBerimond()
    If Time() - lastBerimondExeTime < 6 * MINUTE_ONE Then 
        Exit Function
    End If
    lastBerimondExeTime = Time()
	
    berimondRecruit()
	buildRoom(gBrmdBuildType)
	
    TracePrint "开始处理Berimond活动"
    gotoWorldMap (5)
	
    Dim tryTimes = 0,result
    For i = 0 To 0
        TracePrint "处理批次：" & i
		
        tryTimes = 0
        Do While True
            clearPopWindow
            result = atkBerimondPlan()
            If result >= 0 or tryTimes >= 1 Then 
                Exit Do
            End If
			
            tryTimes = tryTimes+1
        Loop
    Next
	
    /////////////////////////////////////////////////
    clearPopWindow()
    Delay DELAY_OPERATE_RANK(2)
End Function

Function berimondRecruit()
    TracePrint "进入Berimond城市"
    gotoCity (8)
	
    tapMenuMoveLeft(1)
	Dim result = tapMenuAndTry(Array("Attachment:banner_military.png","Attachment:berimond_menu_soldier.png"), DELAY_OPERATE_RANK(1))
    If result = False Then 
        TracePrint "berimond 找不到军事图标"
        Exit Function
    End If
	
	Dim ocrStr = EmpireOcr.ocrNumber(96,635, 117,642)
	If ocrStr = "" Then 
		ocrStr = EmpireOcr.ocrNumber(96,635, 117,642)
	End If
	Dim longCount = Cint(ocrStr)
	Dim shortCount = Cint(EmpireOcr.ocrNumber(96,513, 117,520))
    TracePrint "berimond army: " & shortCount & "," & longCount
    
    If longCount < 400 And shortCount > 400 Then 
        tapPositionTimes(384, 583, 5)
    ElseIf shortCount < 400 And longCount > 400 Then
        tapPositionTimes(384, 463, 5)
    Else 
    	tapPositionTimes(384, 583, 1)
    	tapPositionTimes(384, 463, 1)
    	tapPositionTimes(384, 583, 1)
    	tapPositionTimes(384, 463, 1)
    	tapPositionTimes(384, 583, 1)
    End If
End Function

Function buildRoom(type)
    //build
    clearPopWindow 
    Delay DELAY_OPERATE_RANK(0)
    Dim result = FindPic(0, 0, screenX, screenY, "Attachment:op_build_wait.png|Attachment:op_build_wait_acc.png", "080808", 0, 0.8, intX, intY)
    If intX > -1 And intY > -1 Then 
        If result = 0 Then
            TracePrint "doing..."
            Exit Function
        ElseIf result = 1 Then
            tapPosition intX, intY
            Delay DELAY_OPERATE_RANK(1)
        End If
    End If
	
    FindPicFull "Attachment:banner_build.png"
    If intX = -1 or intY = -1 Then 
        TracePrint "can not find build icon"
        Exit Function
    End If
	
    tapPosition intX, intY
    Delay DELAY_OPERATE_RANK(2)
	
    If type = 1 then
        FindPicFull "Attachment:p_build_tab_military.png|Attachment:p_build_tab_military_x.png"
        If intX = -1 or intY = -1 Then 
            TracePrint "can not find military icon"
            Exit Function
        End If
		
        tapPosition intX, intY
        Delay DELAY_OPERATE_RANK(1)
		
        tapPosition 400, 270
        Delay DELAY_OPERATE_RANK(1)
		
        FindPicFull "Attachment:op_build_confirm.png"
        If intX > -1 and intY > -1 Then 
            tapPosition intX, intY
        End If
    Else 
        FindPicFull "Attachment:p_build_tab_decorate.png"
        If intX = -1 or intY = -1 Then 
            TracePrint "can not find military icon"
            Exit Function
        End If
		
        tapPosition intX, intY
        Delay DELAY_OPERATE_RANK(1)
		
        tapPosition 400, 430
        Delay DELAY_OPERATE_RANK(1)
		
        FindPicFull "Attachment:op_build_confirm.png"
        If intX > -1 and intY > -1 Then 
            tapPosition intX, intY
        End If
    End If
	
    clearPopWindow
End Function

Function atkBerimondPlan
    atkBerimondPlan = -1
    FindPicFull "Attachment:berimond_go_tower.png"
    If intX > -1 And intY > -1 Then 
        tapPosition intX + 10, intY + 10
		
        Delay DELAY_OPERATE_RANK(0)
        Delay DELAY_OPERATE_RANK(2)
		
        If readBase() = -1 Then 
            Exit Function
        End If
		
        tapPosition baseX, baseY
		
        actionConfirm 
		
        Dim result = atkBerimond() 
        atkBerimondPlan = result
		
        If result >= 0 Then 
            //DO
            FindPicFull "Attachment:bat_attack_start.png"
            TracePrint Now() & "Attack X, Y: " & intX & "," & intY
            If intX > -1 and intY > -1 Then 
                tapPosition intX + 5, intY + 5
                Delay DELAY_OPERATE_RANK(0) 
                actionConfirm
            End If
        End If
    End If
End Function

// 100030:无适合指挥官
Function atkBerimond() 
    TracePrint "attacking berimond:"
    atkBerimond = -1
	/*
	//选择指挥官
	If selectCommander(8) <> 8 Then 
		If selectCommander(7) <> 7 Then 
			atkNomads = -100030
			Exit Function
		End If
	End If
	*/

    Delay DELAY_OPERATE_RANK(1)
    Dim cmdId = readCommander()
    If cmdId = 0 Then 
        TracePrint "无法获取指挥官"
        Exit Function
    End If
	
    Dim basicWall = 60 - commanderArray(cmdId-1, 0)
    Dim basicDoor = 60 - commanderArray(cmdId-1, 1)
    Dim basicLong = 0, centerLong = 60
	
	
    Dim cntCenter = 156, cntSide =  52
    Dim fodderTimes = 2, atkTimes = 2, toolTimes = 1, targetType = 15
    Dim sideShortDef = Array(basicWall, 0, 0, basicLong, 100, 4000, 1000,100,100)
    Dim sideLongDef = Array(basicWall, 0, 0, basicLong, 100, 0, 5000,100,100)
    Dim sideShortDefCenter = Array(basicWall, basicDoor, 0, centerLong,100, 5000, 0,100,100)
    Dim sideAll = Array(basicWall, 0, 0, basicLong, 100, 5000, 5000,100,100)
    
    Dim allTargetInfo = Array(4)
    allTargetInfo(SIDE_CENTER) = sideShortDefCenter
    allTargetInfo(SIDE_LEFT) = sideShortDef
    allTargetInfo(SIDE_RIGHT) = sideShortDef
    allTargetInfo(SIDE_INNER) = sideLongDef
    
	
    Dim allAttackData = Array(3)
    allAttackData(SIDE_CENTER) = buildAtkDataComm(allTargetInfo, targetType, SIDE_CENTER, fodderTimes, atkTimes, toolTimes, SIDE_INNER, selectBerimondTools(allTargetInfo(SIDE_CENTER), toolTimes))
    allAttackData(SIDE_LEFT) = buildAtkDataComm(allTargetInfo, targetType, SIDE_LEFT, fodderTimes, atkTimes, toolTimes, SIDE_INNER, selectBerimondTools(allTargetInfo(SIDE_LEFT), toolTimes))
    allAttackData(SIDE_RIGHT) = buildAtkDataComm(allTargetInfo, targetType, SIDE_RIGHT, fodderTimes, atkTimes, toolTimes, SIDE_INNER, selectBerimondTools(allTargetInfo(SIDE_RIGHT), toolTimes))
    
    Dim result = atkSideTurn(allAttackData)
    atkBerimond = result
End Function

Function selectBerimondTools(sideDefData, batchTimes)
    TracePrint "selectBerimondTools: " & Join(sideDefData, ",")
	
	Dim allToolsInfo = Array(1)
    allToolsInfo(0) = Array(3)
    allToolsInfo(0,0) = Array(0, "")
    allToolsInfo(0,1) = Array(0, "")
    allToolsInfo(0,2) = Array(0, "")
    //18 + x, y
    If sideDefData(DF_WALL) > 0 Then 
        allToolsInfo(0,0) = Array((sideDefData(DF_WALL) + 9)\10, "Attachment:slt_tool_ladder.png")
    End If
	
    If sideDefData(DF_LONG) > 0 Then 
        allToolsInfo(0,1) = Array((sideDefData(DF_LONG) + 4)\5, "Attachment:slt_tool_shield.png")
    End If
	
    If sideDefData(DF_DOOR) > 0 Then 
        allToolsInfo(0,2) = Array((sideDefData(DF_DOOR) + 9) \ 10, "Attachment:slt_tool_hammer.png")
    End If
	
	selectBerimondTools = allToolsInfo
End Function


//
Function atkSamurai(targetData)
    Dim cmdId = selectCommanders(Array(1,2,3,4))
    If cmdId < 1 or cmdId > 4 Then 
        atkSamurai =  -100030
        Exit Function
    End If
	
    Dim allTargetInfo = readAllEnimyCity2(targetData(TAGT_TYPE))
    If allTargetInfo(0, 0) <= 0 or allTargetInfo(1, 0) <= 0 or allTargetInfo(2, 0) <= 0 Then 
        TracePrint "数据异常，退出"
        atkSamurai = -1
        Exit Function
    End If
	
    //
    Dim totalShort=0, totalLong=0
    Dim atkIdx = Array(2), curCount, counter = 0
    For i=0 to 2 
        totalShort = totalShort+allTargetInfo(i, DF_NUM_SHORT)
        totalLong = totalLong+allTargetInfo(i, DF_NUM_LONG)
        curCount = allTargetInfo(i, DF_NUM_SHORT) + allTargetInfo(i, DF_NUM_LONG)
		
        if curCount < 5 then
            atkIdx(counter) = i
            counter = counter+1
			
            allTargetInfo(i, DF_WALL)=0
            allTargetInfo(i, DF_DOOR)=0
            allTargetInfo(i, DF_LONG) = 0
            allTargetInfo(i, DF_PW_SHORT)=0
            allTargetInfo(i, DF_PW_LONG)=0
            //allTargetInfo(i, DF_NUM_SHORT)=0
            //allTargetInfo(i, DF_NUM_LONG)=0
        end if
    next
    totalShort = totalShort+allTargetInfo(3, DF_NUM_SHORT)
    totalLong = totalLong+allTargetInfo(3, DF_NUM_LONG)
	
	
    //中+1边，中，三路
    Dim total = totalShort+totalLong
    if total > 800 then
        atkSamurai = -100201
        exit function
    end if
	
    if counter = 2 and atkIdx(0) = SIDE_LEFT and atkIdx(1) = SIDE_RIGHT then
        //left + right
        atkSamurai = -100202
        exit function
    end if
	

    //L+R
    Dim atkSide = -1
    if (allTargetInfo(1, DF_NUM_SHORT) + allTargetInfo(1, DF_NUM_LONG) < 5) or (allTargetInfo(2, DF_NUM_SHORT) + allTargetInfo(2, DF_NUM_LONG) < 5 ) or total > 300 then
        if allTargetInfo(1, DF_NUM_SHORT) < allTargetInfo(2, DF_NUM_SHORT) then
            atkSide = SIDE_LEFT
        else
            atkSide = SIDE_RIGHT
        end if
    else
		
        //only center
    end if
	
    //center
    Dim result = -1,atkTimes = 4, toolTimes=4
    Dim mainBatch = Clone(allTargetInfo(SIDE_CENTER)), secondBatch = Clone(allTargetInfo(SIDE_CENTER))
    If mainBatch(DF_PW_SHORT) > 0 Then
        mainBatch(DF_PW_LONG) = 0
        secondBatch(DF_PW_SHORT) = 0
    ElseIf mainBatch(DF_NUM_SHORT) + mainBatch(DF_NUM_LONG) = 0 Then
        mainBatch(DF_PW_SHORT) = 1000
        secondBatch(DF_PW_LONG) = 1000
    End If
    If mainBatch(DF_NUM_SHORT) > 192 Then 
        toolTimes = 4
    ElseIf mainBatch(DF_NUM_SHORT) > 128 Then
        toolTimes = 3
    ElseIf mainBatch(DF_NUM_SHORT) > 64 Then
        toolTimes = 2
    ElseIf mainBatch(DF_NUM_SHORT) > 3 Then
        toolTimes = 1
    Else 
        toolTimes = 0
    End If
	
	
    result = attackAllocArmy(SIDE_CENTER, mainBatch, secondBatch, 196, 0, atkTimes, toolTimes, 12)
    If result < 0 Then 
        atkSamurai = result
        Exit Function
    Elseif atkSide = -1 Then
        atkSamurai = 1
        Exit Function
    End If
	
    //L/R	
    If atkSide = SIDE_LEFT Then
        tapPosition 55, 326
    ElseIf atkSide = SIDE_RIGHT
        tapPosition 420, 326
    End If
	
    mainBatch = Clone(allTargetInfo(atkSide))
    secondBatch = Clone(allTargetInfo(atkSide))
    If mainBatch(DF_PW_SHORT) > 0 Then 
        mainBatch(DF_PW_LONG) = 0
        secondBatch(DF_PW_LONG) = 0
    ElseIf mainBatch(DF_NUM_SHORT) + mainBatch(DF_NUM_LONG) = 0 Then
        mainBatch(DF_PW_SHORT) = 1000
        secondBatch(DF_PW_LONG) = 1000
    End If
    If mainBatch(DF_NUM_SHORT) > 192 Then 
        toolTimes = 4
    ElseIf mainBatch(DF_NUM_SHORT) > 128 Then
        toolTimes = 3
    ElseIf mainBatch(DF_NUM_SHORT) > 64 Then
        toolTimes = 2
    ElseIf mainBatch(DF_NUM_SHORT) > 3 Then
        toolTimes = 1
    Else 
        toolTimes = 0
    End If
	
    result = attackAllocArmy(atkSide, mainBatch, secondBatch, 64, 0, atkTimes, toolTimes, 12)
    If result <= 0 Then 
        atkSamurai = result
    Else 
        atkSamurai = 1
    End If
	
End Function

// 100030:无适合指挥官
Function atkNomads(targetData, allAttackData) 
    TracePrint "atkNomads:"

    Dim fodderTimes = 0, atkTimes = ymAtkTimes, toolTimes = 1, targetType = targetData(TAGT_TYPE)
	
    //Center+side
    //重新读取谍报
    Dim allTargetInfo
    If targetData(TAGT_LVL) = 0 or targetData(TAGT_LVL) >= 81 Then 
    	//选择指挥官
    	
    	If selectCommander(7) <> 7 Then 
        	If selectCommander(8) <> 8 and gFastCampaingFlag = 0 Then 
            	atkNomads = -100030
            	Exit Function
        	End If
    	End If
    	
		Delay 400
    
        allTargetInfo = readAllEnimyCity(targetData(TAGT_TYPE))
    ElseIf targetData(TAGT_LVL) >= 51 Then
    	allTargetInfo = readAllEnimyCity(targetData(TAGT_TYPE))
        atkTimes = 1
        toolTimes = 1
        fodderTimes = 2
        allTargetInfo (0, DF_lONG) = 80
        allTargetInfo (1, DF_lONG) = 60
        allTargetInfo (2, DF_lONG) = 60
    ElseIf targetData(TAGT_LVL) = 61 Then
    	allTargetInfo = readAllEnimyCity(targetData(TAGT_TYPE))
        atkTimes = 1
        toolTimes = 1
        fodderTimes = 2
    Else 
        allTargetInfo = Array(3)
        allTargetInfo (0) = Array(10, -1, -1, 0, 0, 5000, 5000, 10, 10)
        allTargetInfo (1) = Array(10, -1, -1, 0, 0, 5000, 5000, 10, 10)
        allTargetInfo (2) = Array(10, -1, -1, 0, 0, 5000, 5000, 10, 10)
        atkTimes = 1
        toolTimes = 0
        
        If targetData(TAGT_LVL) > 30 Then
        	atkTimes = 1
        	toolTimes = 0
        	fodderTimes = 1
        ElseIf targetData(TAGT_LVL) <= 30
        	atkTimes = 1
        	toolTimes = 0
        	fodderTimes = 0
        End If
    End If
    
    If allTargetInfo(SIDE_LEFT, 1) <> -1 or allTargetInfo(SIDE_RIGHT, 1) <> -1 Then 
        TracePrint "数据异常，退出"
        atkNomads = -1
        Exit Function
    End If
    
    TracePrint "对方信息："& CommUtil.Join2DimArray(allTargetInfo)
    For tmpInt = 0 To 2
    	If allTargetInfo(tmpInt, DF_WALL) = -1 or allTargetInfo(tmpInt, DF_PW_SHORT) = -1 or allTargetInfo(tmpInt, DF_PW_LONG)=-1 Then 
        	TracePrint "游牧数据异常，退出"
        	atkNomads = -1
        	Exit Function
    	End If
    Next
	
	
	Dim firstSide = SIDE_CENTER
    Dim sideIndex = SIDE_LEFT, baseIndex
    
    If allTargetInfo(SIDE_LEFT, DF_LONG) = 119 And allTargetInfo(SIDE_RIGHT, DF_LONG) = 119 And allTargetInfo(SIDE_CENTER, DF_LONG) > 169 Then 
    	allTargetInfo(SIDE_LEFT, DF_PW_LONG) = 0
    	allTargetInfo(SIDE_RIGHT, DF_PW_LONG) = 0
        
        allAttackData(SIDE_LEFT) = buildAtkDataLong(allTargetInfo, targetType, SIDE_LEFT, fodderTimes, atkTimes, toolTimes, SIDE_CENTER)
        allAttackData(SIDE_RIGHT) = buildAtkDataLong(allTargetInfo, targetType, SIDE_RIGHT, fodderTimes, atkTimes, toolTimes, SIDE_CENTER)
    Else
    	
    	//>119,169,219,269,
    	If allTargetInfo(SIDE_LEFT, DF_LONG) = allTargetInfo(SIDE_RIGHT, DF_LONG) Then 
        	If allTargetInfo(SIDE_LEFT, DF_SHORT) * allTargetInfo(SIDE_LEFT, DF_NUM_SHORT) <= allTargetInfo(SIDE_RIGHT, DF_SHORT) * allTargetInfo(SIDE_RIGHT, DF_NUM_SHORT) Then 
            	//Left
            	sideIndex = SIDE_LEFT
        	Else 
            	//Right
            	sideIndex = SIDE_RIGHT 
        	End If
			
    	ElseIf (allTargetInfo(SIDE_LEFT, DF_LONG) > 169 And allTargetInfo(SIDE_RIGHT, DF_LONG) > 169) or  (allTargetInfo(SIDE_LEFT, DF_LONG) <= 169 And allTargetInfo(SIDE_RIGHT, DF_LONG) <= 169) Then
        	//人数优势
        	If allTargetInfo(SIDE_LEFT, DF_SHORT) * allTargetInfo(SIDE_LEFT, DF_NUM_SHORT) <= allTargetInfo(SIDE_RIGHT, DF_SHORT) * allTargetInfo(SIDE_RIGHT, DF_NUM_SHORT) Then 
            	//Left
            	sideIndex = SIDE_LEFT
        	Else 
            	//Right
            	sideIndex = SIDE_RIGHT
        	End If
    	ElseIf allTargetInfo(SIDE_LEFT, DF_LONG) < allTargetInfo(SIDE_RIGHT, DF_LONG) Then
        	//LEFT
        	sideIndex = SIDE_LEFT
    	Else
        	//RIGHT
        	sideIndex = SIDE_RIGHT
    	End If
		
		
    	//2波，
    	If sideIndex = SIDE_LEFT Then 
        	baseIndex = SIDE_RIGHT
    	Else 
        	baseIndex = SIDE_LEFT
    	End If
    	
    	allTargetInfo(firstSide, DF_PW_LONG) = 0
    	allTargetInfo(sideIndex, DF_PW_LONG) = 0
    	If 2*allTargetInfo(baseIndex, DF_NUM_LONG) > allTargetInfo(baseIndex, DF_NUM_SHORT) Then 
    		allTargetInfo(baseIndex, DF_PW_SHORT) = 0
    	Else 
    		allTargetInfo(baseIndex, DF_PW_LONG) = 0
    	End If
    	
        //ymCenterToolTimes = 1,ymAtkTimes=4
        allAttackData(SIDE_CENTER) = buildAtkDataLong(allTargetInfo, targetType, SIDE_CENTER, fodderTimes, atkTimes, ymCenterToolTimes, baseIndex)
        allAttackData(sideIndex) = buildAtkDataLong(allTargetInfo, targetType, sideIndex, fodderTimes, atkTimes, toolTimes, baseIndex)
    End If
    atkNomads=0
End Function

Function buildAtkDataComm(allTargetInfo, atkType, sideIndex, fodderTimes, atkTimes, toolTimes, baseIndex, toolData)
    Dim allAttackData = Array(true, 0, 0)
    allAttackData(ATK_DATA_ARGS) = Array(atkType, sideIndex, fodderTimes, atkTimes, toolTimes, 0)
    //ATK_TYPE=0, ATK_SIDE_IDX=1, ATK_FODDER_TURNS=2, ATK_TURNS=3, ATK_TOOL_TURNS=4, ATK_TOOL_EXTRA=5
    allAttackData(ATK_DATA_TOOL) = toolData
    allAttackData(ATK_DATA_DEF) = allTargetInfo(sideIndex)
    allAttackData(ATK_DATA_BASE) = allTargetInfo(baseIndex)
    allTargetInfo(DF_PW_LONG) = 0
    
    buildAtkDataComm = allAttackData
End Function

Function buildAtkDataLong(allTargetInfo, atkType, sideIndex, fodderTimes, atkTimes, toolTimes, baseIndex)
    Dim allAttackData = Array(true, 0, 0)
    allAttackData(ATK_DATA_ARGS) = Array(atkType, sideIndex, fodderTimes, atkTimes, toolTimes, 0)
    //ATK_TYPE=0, ATK_SIDE_IDX=1, ATK_FODDER_TURNS=2, ATK_TURNS=3, ATK_TOOL_TURNS=4, ATK_TOOL_EXTRA=5
    allAttackData(ATK_DATA_TOOL) = selectNomadsTools(allTargetInfo(sideIndex), toolTimes)
    allAttackData(ATK_DATA_DEF) = allTargetInfo(sideIndex)
    allAttackData(ATK_DATA_BASE) = allTargetInfo(baseIndex)
    allTargetInfo(DF_PW_LONG) = 0
    
    buildAtkDataLong = allAttackData
End Function


Function selectNomadsTools(sideDefData, batchTimes)	
    //BaseX, BaseY+160
    TracePrint "selectNomadsTools: " & Join(sideDefData, ",")
    
    Dim allToolsInfo = Array(batchTimes)
    Dim toolsInfo = Array(3), ladderCnt, hammerCnt,shieldCnt
    toolsInfo(0) = Array(0, "")
    toolsInfo(1) = Array(0, "")
    toolsInfo(2) = Array(0, "")
    Dim toolShieldArray = Array("Attachment:slt_tool_shield.png","Attachment:slt_tool_shield_wawa.png","Attachment:slt_tool_iron_shield.png")
	
	Dim shieldType = gFastCampaingFlag-1
	If shieldType = -1 Then 
		shieldType = 0
	End If
	Dim shieldValue = (shieldType+1)*5
	
	
    If sideDefData(DF_DOOR) > 0 Then
        If sideDefData(DF_LONG) >= 219 Then
            If gFastCampaingFlag > 1 Then
            	//+10,+15
            	toolsInfo(0) = Array((sideDefData(DF_LONG)+shieldValue-1) \ shieldValue, toolShieldArray(shieldType))
            	toolsInfo(1) = Array((sideDefData(DF_WALL) + 9) \ 10, "Attachment:slt_tool_ladder.png", 6)
            	toolsInfo(2) = Array((sideDefData(DF_DOOR) + 9) \ 10, "Attachment:slt_tool_hammer.png", 6)
            Else
            	//wood or mix
            	ladderCnt = (sideDefData(DF_WALL)+10)\20
            	hammerCnt = (sideDefData(DF_DOOR)+10)\20
            	Dim cnt = CInt(sideDefData(DF_NUM_SHORT) * sideDefData(DF_SHORT) / 100 / 15)
            	If cnt >= (ladderCnt + hammerCnt) Then 
                	cnt = ladderCnt + hammerCnt
            	Elseif cnt >= hammerCnt Then
                	hammerCnt = hammerCnt - 1
            	Else 
                	hammerCnt = cnt -1
            	End If
            	ladderCnt = cnt - hammerCnt
				
				
            	toolsInfo(0) = Array(ladderCnt, "Attachment:slt_tool_iron_ladder.png")
            	toolsInfo(1) = Array(hammerCnt, "Attachment:slt_tool_iron_hammer.png")
            	toolsInfo(2) = Array(50 - cnt, "Attachment:slt_tool_shield.png", 6)
			End If
        ElseIf sideDefData(DF_LONG) = 169 Then
            //34 + x + y
            If gFastCampaingFlag > 1 Then 
            	toolsInfo(0) = Array((sideDefData(DF_LONG)+shieldValue-1) \ shieldValue, toolShieldArray(shieldType))
            	toolsInfo(1) = Array((sideDefData(DF_WALL)+9)\10, "Attachment:slt_tool_ladder.png", 6)
            	toolsInfo(2) = Array((sideDefData(DF_DOOR)+9)\10, "Attachment:slt_tool_hammer.png", 6)
			/*          
			ElseIf gFastCampaingFlag = 1 Then
            	ladderCnt = (sideDefData(DF_WALL)+9) \ 10
            	hammerCnt = (sideDefData(DF_DOOR) + 9) \ 10
            	If sideDefData(DF_NUM_SHORT) > sideDefData(DF_NUM_LONG) Then 
            		toolsInfo(0) = Array(hammerCnt, "Attachment:slt_tool_hammer.png")
            		toolsInfo(1) = Array(ladderCnt, "Attachment:slt_tool_ladder.png")
            		toolsInfo(2) = Array(34, toolShieldArray(shieldType), 6)
            	Else
            		toolsInfo(0) = Array(34, toolShieldArray(shieldType))
            		toolsInfo(1) = Array(ladderCnt, "Attachment:slt_tool_ladder.png", 6)
            		toolsInfo(2) = Array(hammerCnt, "Attachment:slt_tool_hammer.png", 6)
            	End If
            	*/
            Else 
            	//mix 34+iron hammer+ladder
            	toolsInfo(0) = Array(34, toolShieldArray(shieldType))
            	toolsInfo(1) = Array((sideDefData(DF_DOOR) + 19) \ 20, "Attachment:slt_tool_iron_hammer.png", 6)
            	toolsInfo(2) = Array((sideDefData(DF_WALL) + 9) \ 10, "Attachment:slt_tool_ladder.png", 6)
            End If
        ElseIf sideDefData(DF_LONG) <= 119 Then
            //24 + x
            //toolsInfo(0) = Array(24, "Attachment:slt_tool_shield.png")
            
            toolsInfo(0) = Array((sideDefData(DF_LONG)+shieldValue-1) \ shieldValue, toolShieldArray(shieldType))
            toolsInfo(1) = Array((sideDefData(DF_WALL)+9)\10, "Attachment:slt_tool_ladder.png")
            toolsInfo(2) = Array((sideDefData(DF_DOOR)+9)\10, "Attachment:slt_tool_hammer.png")
        Else 
			TracePrint "[ERROR] Not support logic."
        End If
    Else
        If sideDefData(DF_LONG) >= 219 Then
            If gFastCampaingFlag > 1 Then
            	//+10,+15
            	toolsInfo(0) = Array((sideDefData(DF_LONG)+shieldValue-1) \ shieldValue, toolShieldArray(shieldType))
            	toolsInfo(1) = Array((sideDefData(DF_WALL) + 9) \ 10, "Attachment:slt_tool_ladder.png",6)
            Else
            	//wood or mix
            	ladderCnt = (sideDefData(DF_WALL)+10)\20
            	toolsInfo(0) = Array(ladderCnt, "Attachment:slt_tool_iron_ladder.png")
            	toolsInfo(1) = Array(50 - cnt, "Attachment:slt_tool_shield.png", 6)
			End If
        ElseIf sideDefData(DF_LONG) = 169 Then
            If gFastCampaingFlag > 1 Then 
            	toolsInfo(0) = Array((sideDefData(DF_LONG)+shieldValue-1) \ shieldValue, toolShieldArray(shieldType))
            	toolsInfo(1) = Array((sideDefData(DF_WALL)+9)\10, "Attachment:slt_tool_ladder.png", 6)
            ElseIf gFastCampaingFlag = 1 Then
            	ladderCnt = (sideDefData(DF_WALL)+9) \ 10
            	If sideDefData(DF_NUM_SHORT) > sideDefData(DF_NUM_LONG) Then 
            		toolsInfo(0) = Array(ladderCnt, "Attachment:slt_tool_ladder.png")
            		toolsInfo(1) = Array(34, toolShieldArray(shieldType), 6)
            	Else
            		toolsInfo(0) = Array(34, toolShieldArray(shieldType))
            		toolsInfo(1) = Array(ladderCnt, "Attachment:slt_tool_ladder.png", 6)
            	End If
            Else 
            	//mix 34+iron hammer+ladder
            	toolsInfo(0) = Array(34, toolShieldArray(shieldType))
            	toolsInfo(1) = Array((sideDefData(DF_WALL) + 19) \ 20, "Attachment:slt_tool_iron_ladder.png", 6)
            End If
        ElseIf sideDefData(DF_LONG) <= 119 Then
            toolsInfo(0) = Array((sideDefData(DF_LONG)+shieldValue-1) \ shieldValue, toolShieldArray(shieldType))
            toolsInfo(1) = Array((sideDefData(DF_WALL)+9)\10, "Attachment:slt_tool_ladder.png", 6)
        Else 
            TracePrint "[ERROR] Not support logic."
        End If
    End If
	
	allToolsInfo(0) = toolsInfo
	
		//第二波工具特殊处理
	
    If batchTimes > 1 Then 
    	Dim tmpToolsInfo = Array(1)
    	tmpToolsInfo(0) = Array(3,"Attachment:slt_tool_box.png", 6)
    	
    	allToolsInfo(1) = tmpToolsInfo
    End If
	
	
	TracePrint "Tool info: " & CommUtil.Join3DimArray(allToolsInfo)
	selectNomadsTools = allToolsInfo
End Function






///////////////////////////////////////////////
//
// 结果值1：准备完毕， <=0: 异常，根据异常码处理
// SPY: Wall,Door,River,Long,Short, 
// L180:DF_WALL=0,DF_DOOR=1,DF_RIVER=2,DF_LONG=3,DF_SHORT=4,DF_PW_SHORT=5,DF_PW_LONG=6,DF_NUM_SHORT=7,DF_NUM_LONG=8
///////////////////////////////////////////////
Function atkBrigands(targetData, allAttackData)
    TracePrint "atkBrigands:" & targetData(TAGT_LVL)
	
    Dim allTargetInfo
    If targetData(TAGT_LVL) <= 12 Then 
    	allTargetInfo = Array(3)
    	allTargetInfo (0) = Array(10, -1, -1, 0, 0, 5000, 0, 10, 0)
    	allTargetInfo (1) = Array(10, -1, -1, 0, 0, 5000, 0, 10, 0)
    	allTargetInfo (2) = Array(10, -1, -1, 0, 0, 0, 5000, 0, 10)
    ElseIf targetData(TAGT_LVL) < 24 Then
    	allTargetInfo = Array(3)
    	allTargetInfo (0) = Array(10, -1, -1, 0, 0, 5000, 5000, 10, 10)
    	allTargetInfo (1) = Array(10, -1, -1, 0, 0, 5000, 5000, 10, 10)
    	allTargetInfo (2) = Array(10, -1, -1, 0, 0, 5000, 5000, 10, 10)
    ElseIf targetData(TAGT_TYPE) = 1 and targetData(TAGT_LVL) = 51 Then
    	allTargetInfo = Array(3)
    	allTargetInfo (0) = Array(200, 199, 0, 125, 126, 0, 0, 0, 0)
    	allTargetInfo (1) = Array(200, 0, 0, 125, 126, 1000, 0, 100, 0)
    	allTargetInfo (2) = Array(200, 0, 0, 125, 126, 980, 0, 98, 0)
    	allTargetInfo (3) = Array(0, 0, 0, 125, 126, 2000, 0, 376, 0)
    Else 
    	allTargetInfo = readAllEnimyCity2(targetData(TAGT_TYPE))
    End If
    
    TracePrint "对方信息："& CommUtil.Join2DimArray(allTargetInfo)
    If allTargetInfo(0, 0) = -1 or allTargetInfo(1, 0) = -1 or allTargetInfo(2, 0) = -1 Then 
        TracePrint "数据异常，退出"
        atkBrigands = -1
        Exit Function
    End If
	
    Dim basicWall = 0, basicDoor=0
	
    //计算基准出兵数量
    Dim cntCenter = 4+targetData(TAGT_LVL)*3
    Dim cntSide =  2+targetData(TAGT_LVL)
    If targetData(TAGT_LVL) >= 70 Then 
    ElseIf targetData(TAGT_LVL) >= 60 Then
    ElseIf targetData(TAGT_LVL) >= 50 Then
        cntCenter = 156
        cntSide = 52
    End If
	
	
    //真是数量则，需要根据指挥官修正
    //
	
    Dim towerBasic = brigandsTower(targetData(TAGT_TYPE), 0)
    For i = 0 To UBOUND(brigandsTower(targetData(TAGT_TYPE)))
        //TracePrint targetData(TAGT_TYPE) & "," &brigandsTower(targetData(TAGT_TYPE), i, 0)
		

        If targetData(TAGT_LVL) <= brigandsTower(targetData(TAGT_TYPE), i, 0) Then 
            //TracePrint "xxxx" & Join(brigandsTower(targetData(TAGT_TYPE), i), ",")
            towerBasic = brigandsTower(targetData(TAGT_TYPE), i)
            Exit For
        End If
		

    Next
	
    Dim gear = targetData(TAGT_LVL) \ 10
    Dim atkTimeCenter = towerBasic(3)
    Dim atkTimeSide = towerBasic(4)
    Dim atkCannonTimes= towerBasic(5)
    //TracePrint "info:" & atkTimeCenter &"," & atkTimeSide & "," &atkCannonTimes
	
    If targetData(TAGT_LVL) >= 24 Then 
        //获取指挥官
        Dim cmdId = readCommander()
        If cmdId < 1 or cmdId > 8 Then 
            TracePrint "commander exception: " & cmdId
            atkBrigands = -1
            Exit Function
        End If
		
		
        //wall, dor, ri, long, short
        basicWall = towerBasic(1) + brigandsCmd(gear, 0) - commanderArray(cmdId - 1, 0)
        basicDoor = towerBasic(2) + brigandsCmd(gear, 1) - commanderArray(cmdId - 1, 1)
        //TracePrint "basic wall:" & basicWall
    End If
	
    Dim originTargetInfo = Clone(allTargetInfo)
    //TracePrint "Clone信息："& CommUtil.Join2DimArray(originTargetInfo) 
	
	If targetData(TAGT_LVL) >= 24 And atkCannonTimes > 0 Then
    	For i = 0 To 2
        	if CInt(allTargetInfo(i, DF_WALL)) > basicWall Then
            	allTargetInfo(i, DF_WALL) = basicWall
        	End If
        	allTargetInfo(i, DF_DOOR) = 0
        	allTargetInfo(i, DF_RIVER) = 0
			
        	If targetData(TAGT_LVL) <= 11 Then 
            	//only one type
            	If allTargetInfo(i, DF_PW_SHORT) <> 0 And allTargetInfo(i, DF_PW_LONG) <> 0 Then 
                	If allTargetInfo(i, DF_PW_SHORT) > allTargetInfo(i, DF_PW_LONG) Then 
                    	allTargetInfo(i, DF_PW_LONG) = 0
                	Else
                    	allTargetInfo(i, DF_PW_SHORT) = 0
                	End If
					
            	End If
        	End If
    	Next
    End If
	
    //Dim cloneTargetData = Clone(targetData)
    //type,
    Dim targetType = targetData(TAGT_TYPE)
    //修正出兵
    If targetType = 3 And targetData(TAGT_LVL) = 71 Then 
        //Lvl:71,Inner has soldier
        allTargetInfo(SIDE_CENTER, DF_PW_LONG) = allTargetInfo(SIDE_CENTER, DF_PW_SHORT)
        allTargetInfo(SIDE_CENTER, DF_PW_SHORT) = originTargetInfo(SIDE_CENTER, DF_PW_LONG)
        allTargetInfo(SIDE_CENTER, DF_NUM_LONG) = allTargetInfo(SIDE_CENTER, DF_NUM_SHORT)
        allTargetInfo(SIDE_CENTER, DF_NUM_SHORT) = 0
    End If
	
	
    Dim result
    //中间空
    If allTargetInfo(SIDE_CENTER, DF_PW_SHORT) = 0 And allTargetInfo(SIDE_CENTER, DF_PW_LONG) = 0 Then 
        
        
        If allTargetInfo(SIDE_RIGHT, DF_PW_SHORT) <> 0 And allTargetInfo(SIDE_LEFT, DF_PW_SHORT) <> -1 _ 
        and (allTargetInfo(SIDE_LEFT, DF_PW_SHORT) + allTargetInfo(SIDE_LEFT, DF_PW_LONG)) < (allTargetInfo(SIDE_RIGHT, DF_PW_SHORT) + allTargetInfo(SIDE_RIGHT, DF_PW_LONG)) Then 
        	
        	allAttackData(SIDE_CENTER) = buildAtkData(allTargetInfo, targetType, SIDE_CENTER, 0, atkTimeCenter, 0, SIDE_RIGHT)
        	allAttackData(SIDE_LEFT) = buildAtkData(allTargetInfo, targetType, SIDE_LEFT, atkCannonTimes, atkTimeSide, 1, SIDE_RIGHT)
    	Else 
        	
        	allAttackData(SIDE_CENTER) = buildAtkData(allTargetInfo, targetType, SIDE_CENTER, 0, atkTimeCenter, 0, SIDE_LEFT)
        	allAttackData(SIDE_RIGHT) = buildAtkData(allTargetInfo, targetType, SIDE_RIGHT, atkCannonTimes, atkTimeSide, 1, SIDE_LEFT)
    	End If
	Else
    	//TracePrint "R+L"			
    	//需要选择一面主力
    	Dim atkWavesL=atkTimeSide, atkWavesR=atkTimeSide, atkCannonTimesL=atkCannonTimes, atkCannonTimesR=atkCannonTimes
    	If atkCannonTimes = 3 Then 
        	If allTargetInfo(SIDE_LEFT, DF_PW_SHORT) = -1 or allTargetInfo(SIDE_LEFT, DF_PW_SHORT) = -1 Then 
            	//
            	atkBrigands = 0
            	TracePrint ">=70, need complete data."
            	Exit Function
        	End If
				
        	if (originTargetInfo(SIDE_LEFT, DF_PW_SHORT)*originTargetInfo(SIDE_LEFT, DF_PW_SHORT)+ originTargetInfo(SIDE_LEFT, DF_PW_LONG)*originTargetInfo(SIDE_LEFT, DF_PW_LONG))< _
				(originTargetInfo(SIDE_RIGHT, DF_PW_SHORT)*originTargetInfo(SIDE_RIGHT, DF_PW_SHORT)+ originTargetInfo(SIDE_RIGHT, DF_PW_LONG)*originTargetInfo(SIDE_RIGHT, DF_PW_LONG)) Then
            	atkWavesL = 4
            	atkCannonTimesL = 0
            	allTargetInfo(SIDE_LEFT, DF_WALL) = originTargetInfo(SIDE_LEFT, DF_WALL)
					
        	Else 
            	atkWavesR = 4
            	atkCannonTimesR = 0
            	allTargetInfo(SIDE_RIGHT, DF_WALL) = originTargetInfo(SIDE_RIGHT, DF_WALL)
        	End If
    	End If
    	
    	TracePrint "修正数据"& CommUtil.Join2DimArray(allTargetInfo) 
        allAttackData(SIDE_LEFT) = buildAtkData(allTargetInfo, targetType, SIDE_LEFT, atkCannonTimesL, atkWavesL, 1, SIDE_CENTER)
        allAttackData(SIDE_RIGHT) = buildAtkData(allTargetInfo, targetType, SIDE_RIGHT, atkCannonTimesR, atkWavesR, 1, SIDE_CENTER)
	End If
	
	atkBrigands = 1
End Function


Function buildAtkData(allTargetInfo, atkType, sideIndex, fodderTimes, atkTimes, toolTimes, baseIndex)
    Dim allAttackData = Array(true, 0, 0)
    allAttackData(ATK_DATA_ARGS) = Array(atkType, sideIndex, fodderTimes, atkTimes, toolTimes, 0)
    //ATK_TYPE=0, ATK_SIDE_IDX=1, ATK_FODDER_TURNS=2, ATK_TURNS=3, ATK_TOOL_TURNS=4, ATK_TOOL_EXTRA=5
    allAttackData(ATK_DATA_TOOL) = sltToolsSimple(allTargetInfo(sideIndex), toolTimes)
    allAttackData(ATK_DATA_DEF) = allTargetInfo(sideIndex)
    allAttackData(ATK_DATA_BASE) = allTargetInfo(baseIndex)
    
    buildAtkData = allAttackData
End Function

Function sltToolsSimple(sideDefData, toolTimes)
    Dim allToolsInfo = Array(toolTimes)
    allToolsInfo(0) = Array(1)
    allToolsInfo(0,0) = Array(0, "")
	
	sltToolsSimple = allToolsInfo
    
    If sideDefData(DF_PW_SHORT) < 1000 and sideDefData(DF_PW_LONG) < 1000 And sideDefData(DF_WALL)<100 Then 
        TracePrint "Skip tools for min attack"
        Exit Function
    End If
	
    Dim count = (Cint(sideDefData(DF_WALL))+9)\10
    If count < 1 Then 
        Exit Function
    Else 
    	allToolsInfo(0,0) = Array(count, "Attachment:slt_tool_ladder.png")
    End If
End Function

Function readCommander()
    //TracePrint "xxxxx: " & Time
    Dim cmdId = -1
    Dim result = EmpireOcr.ocrNumber2(29,774,52,781, 1)
    //TracePrint result
    If result <> "" Then 
        readCommander = CInt(result)
        Exit Function
    End If
		
    Delay DELAY_OPERATE_RANK(0)
    tapPosition(40, 764)
    Delay DELAY_OPERATE_RANK(0)
    //level:188, 212, 205, 221
    Dim str = EmpireOcr.ocrNumber(180, 210, 205, 225)
    //TracePrint "commander:" & str
	
    actionConfirm()
	
    readCommander = CInt(str)
End Function

Function selectCommanders(cmdIds)
    Dim result = -1
    For Each cmdId In cmdIds
        result = selectCommander(cmdId)
        If result > 0 Then 
            Exit For
        End If
    Next
	
    selectCommanders = result
End Function

Function selectCommander(cmdId)
    //TracePrint "xxxxx: " & Time
    Dim curId = 1
    Dim result = EmpireOcr.ocrNumber2(29,774,52,781, 1)
    If result <> "" Then 
        curId = CInt(result)
    End If

    selectCommander = -1
    If cmdId = curId Then 
        selectCommander = cmdId
        Exit Function
    ElseIf cmdId < curId Then
        Exit Function
    Else
        //Dim size = cmdId - curId
		
        Delay DELAY_OPERATE_RANK(0)
        tapPosition(40, 764)
        Delay DELAY_OPERATE_RANK(0)
        For i = curId To cmdId-1
            tapPosition 330,140
        Next
		
        Dim str = OCR(180, 210, 205, 226, "2A3748-303030|495A6B-202020|667B8C-201510", 0.9)
        TracePrint str
        curId =  CInt(str)
        If curId=0 or curId = cmdId Then 
            FindPicFull "Attachment:op_confirm.png"
            If intX > -1 and intY > -1 Then 
                selectCommander = curId
                tapPosition intX + 5, intY + 5
				
                If curId = 0 Then 
                    Delay DELAY_OPERATE_RANK(1)
                    selectCommander = EmpireOcr.ocrNumber2(29, 774, 52, 781, 1)
                    //TracePrint selectCommander
                End If
            Else 
                actionCancle()
            End If
        Else 
            actionCancle()
        End If
    End If
End Function

Function readAtkNumber(px, py, sideIndex)
    Dim  result = Array(2)
    //60,116,110,124
    //64,212,105,220
    CommUtil.capKeepMem(0)
    If sideIndex = SIDE_CENTER Then
        result(0)=CInt(EmpireOcr.ocrNumber(px+10,py+116,px+60, py+124))
        result(1)=CInt(EmpireOcr.ocrNumber(px+10,py+212,px+60, py+220))
    Else
        //30->80
        result(0)=CInt(EmpireOcr.ocrNumber(px+10,py+116,px+60, py+124))
        result(1)=CInt(EmpireOcr.ocrNumber(px+10,py+212,px+60, py+220))
    End If
    CommUtil.capRealseMem 
    readAtkNumber = result
End Function

//基础近远防，基础近远攻
//batchImgArray:出兵的波次
Function attackAllocArmy(sideIndex, sideDefData, otherSideDefData, total, cannonSoldier, times, toolTimes, targetType)	
    Dim tmpToolTimes = 0, sltResult=-1, defData=sideDefData
    attackAllocArmy = 0
	
	TracePrint "AttackAllocArmy[ side=" & sideIndex & ",total=" & total & ", cannonSoldier=" & cannonSoldier & " ,times= " & times & ", toolTimes=" & toolTimes & ", targetType=" & targetType & "]"
	TracePrint "main side defence: " & Join(sideDefData, ",")
	TracePrint "backup side defence: " & Join(otherSideDefData, ",")
	
	
    If sideDefData(DF_PW_SHORT) + sideDefData(DF_PW_LONG) = 0 Then 
        cannonSoldier = 0
        toolTimes = 0
        TracePrint "fix cannon foder and tools to zero."
    End If
	
	//bug fix
	//dragMove 180, 610, 400, 0
	//Delay DELAY_OPERATE_RANK(1)
	
	
    Dim amountArray
	
    Delay DELAY_OPERATE_RANK(0) 
    For i = 1 To 4
        FindPicFull atkWavesMark(i-1)
        //FindPic( 0, 0, 0, 0,  batchImgArray(i), "080808", 0, 0.8, intX, intY)
        If intX > -1 And intY > -1 Then 
            Dim tmpX=intX, tmpY=intY
            If i = 1 Then 
                amountArray = readAtkNumber(tmpX, tmpY, sideIndex)
                //TracePrint "attack pre count:" & Join(amountArray, ",")
            End If
			
            //转换初始点
            If sideIndex = SIDE_CENTER Then 
                tmpX = tmpX - 50
            Else 
                tmpX = tmpX - 15
            End If
			
            If cannonSoldier >= i Then 
                sltResult = selectCannonSoldier(tmpX, tmpY)
                //TracePrint "Select soldier (cannon) " & sltResult
                If sltResult = 0 Then 
                    TracePrint "not cannon soldier: " & sltResult
                    sltResult = -100021
                    Exit For
                End If
            ElseIf times+cannonSoldier >= i Then
                //tapPosition intX, intY + 80
				
                //base (targetType < 10 and i - cannonSoldier > 1) or (targetType >= 10 and (i - cannonSoldier) Mod 2 = 0)
                Dim realAtkNo = i - cannonSoldier
                If (sideDefData(DF_PW_SHORT) + sideDefData(DF_PW_LONG) = 0) or (targetType < 10 and realAtkNo > 1) or (targetType>=10 and realAtkNo Mod 2 = 0)Then 
                    defData = otherSideDefData
                Else 
                    defData=sideDefData
                End If
				
                //TracePrint Now() & " Enemy info " & Join(defData, ",")
                total = amountArray(0)
                sltResult = selectAtkSoldier(tmpX, tmpY, defData, total)
                TracePrint "Select soldier (attack) " & sltResult
                
                If sltResult < (total - total \ 10) Then 
                    TracePrint "not enough soldier: " & sltResult
                    sltResult = -100022
                    Exit For
                End If
				
				
				
                //wuqi
                If tmpToolTimes < toolTimes  Then 
                    //wall
                    Dim sltToolResult = 0
                    If targetType = 11 Then 
                        //sltToolResult = selectNomadsTools(tmpX, tmpY, defData, tmpToolTimes)
                    ElseIf targetType = 12 Then
                        sltToolResult = sltToolsSamurai(tmpX, tmpY, defData, amountArray(0))
                    ElseIf targetType = 15 Then
                        //sltToolResult = selectBerimondTools(tmpX, tmpY, defData)
                    Else
                        sltToolResult = selectTools(tmpX, tmpY, defData)
                    End If
					
					//TracePrint "Select soldier (tools) " & sltResult
                    If sltToolResult < 0 Then 
                        sltResult = sltToolResult
                        Exit For                
                    End If
					
                    tmpToolTimes = tmpToolTimes+1
                End If
            End If
			
			
            If times + cannonSoldier <= i Then 
                Exit For
            End If
			
			
            //side:150, cener:220
            Delay DELAY_OPERATE_RANK(0)
            If sideIndex = SIDE_CENTER Then
				
                dragMove 370, 515, -220, 0
                If i= 3 Then
                    Delay DELAY_OPERATE_RANK(1)
                End If
            Else 
                If i < 3 Then
                    dragMove 370, 515, -150, 0
                End If
            End If
            Delay DELAY_OPERATE_RANK(1)
        Else 
            TracePrint "找不到波次:" & i & "," & atkWavesMark(i-1)
            sltResult = -20
            Exit For
        End If
    Next
	
    attackAllocArmy = sltResult
End Function

Function selectTools(px, py, sideDefData)
    //BaseX, BaseY+160
    selectTools = 0
    If sideDefData(DF_PW_SHORT) < 1000 and sideDefData(DF_PW_LONG) < 1000 And sideDefData(DF_WALL)<100 Then 
        TracePrint "Skip tools for min attack"
        Exit Function
    End If
	
    Dim count = (Cint(sideDefData(DF_WALL))+9)\10
    If count < 1 Then 
        Exit Function
    End If
	
    Dim images = "Attachment:slt_tool_ladder.png"
    Dim realNum = selectSoldierNum(px, py+181, images, 5, count, false)
    If realNum < count Then
        TracePrint "not enough tools: " & realNum
        selectTools = -100023
    Else 
        selectTools = realNum
    End If
	
End Function

Function sltToolsSamurai(px, py, sideDefData, total)
    //wall, door, long
    //BaseX, BaseY+160
    TracePrint "selectBerimondTools: " & Join(sideDefData, ",")
	
	
    Dim toolsInfo = Array(3),size = 3, resultNum = Array(3)
    toolsInfo(0) = Array(0, "")
    toolsInfo(1) = Array(0, "")
    toolsInfo(2) = Array(0, "")
    //18 + x, y
    If sideDefData(DF_WALL) > 0 Then 
        toolsInfo(0) = Array((sideDefData(DF_WALL) + 24)\25, "Attachment:slt_tool_samurai_ladder.png")
    End If
	
    If sideDefData(DF_LONG) > 0 Then 
        toolsInfo(1) = Array((sideDefData(DF_LONG) + 19)\20, "Attachment:slt_tool_samurai_shield.png")
    End If
	
    If sideDefData(DF_DOOR) > 0 Then 
        toolsInfo(2) = Array((sideDefData(DF_DOOR) + 24) \ 25, "Attachment:slt_tool_samurai_hammer.png")
    Else 
        size = 2
    End If
	
    sltToolsSamurai = 0
    For i = 0 To size-1
        Dim realNum = selectSoldierNum(px+i*68, py+181, toolsInfo(i,1), 5, toolsInfo(i,0), false)
        If realNum <  toolsInfo(i, 0) Then
            TracePrint "not enough tools: " & realNum
            sltToolsSamurai = -100023
            Exit For
        Else 
            resultNum(i) = realNum
        End If	
    Next
	
    Delay DELAY_OPERATE_RANK(1)
End Function


Function readActualTools(px, py, size)
    Dim result = Array(size)
	
    CommUtil.capKeepMem(0)
    //Y:191-198, X1:-10,+10: Center:68X
    For i = 0 To size - 1
        result(i) = CInt(EmpireOcr.ocrNumber(px-10+68*i,py+191,px+10+68*i, py+198))
    Next	
    CommUtil.capRealseMem 
	
    TracePrint "Read Tools: " & Join(result, ",")
	
    readActualTools = result
End Function

Function readActualArmy(px, py, size)
    Dim result = Array(size)
	
    CommUtil.capKeepMem(0)
    //Y:90-97, X1:-10,+10: Center:68X
    For i = 0 To size - 1
        result(i) = CInt(EmpireOcr.ocrNumber(px-10+68*i,py+90,px+10+68*i, py+97))
    Next	
    CommUtil.capRealseMem 
	
    //TracePrint "Read Army: " & Join(result, ",")
	
    readActualArmy = result
End Function

Function selectAtkSoldier(basePx, basePy, defData, total)
    //TracePrint "selectAtkSoldier:" & Join(defData, ",")
	
    Dim px=basePx,py=basePy+80
    Dim shortAtk, zhandouli = defData(DF_PW_SHORT)+defData(DF_PW_LONG)
    If zhandouli = 0 or defData(5) = -1 or defData(DF_PW_LONG) = -1 Then
        shortAtk = 0.5
    ElseIf defData(DF_NUM_SHORT) = 0 Then
        shortAtk = 0
    ElseIf defData(DF_NUM_LONG) = 0 Then
        shortAtk = 1
    Else
        shortAtk = defData(DF_PW_SHORT)/(defData(DF_PW_SHORT)+defData(DF_PW_LONG))
    End If
	
	//3:half-all,4:all   (level 12:side is one, 14)
	Dim firstSltMode = 3
	If total < 15 Then 
		firstSltMode = 4 
	End If
	
    Dim amount = Array(0, 0)
    If shortAtk < 0.33 Then 
        amount(0) = selectShortSoldier(px, py, firstSltMode, total)
        If amount(0) < total Then
            amount(1) = selectShortSoldier(px+68, py, 4, total-amount(0))
        End If
    ElseIf shortAtk < 0.40 Then
        amount(0) = selectShortSoldier(px, py, 5, total*3/4)
        If amount(0) > 0 Then
            amount(1) = selectLongSoldier(px + 68, py, 4, total - amount(0))
        End If
    ElseIf shortAtk < 0.6 Then
        amount(0) = selectShortSoldier(px, py, 5, total\2)
        If amount(0) > 0 Then
            amount(1) = selectLongSoldier(px + 68, py, 4, total - amount(0))
        End If
    ElseIf shortAtk < 0.67 Then
        amount(0) = selectShortSoldier(px, py, 5, total\4)
        If amount(0) > 0 Then
            amount(1) = selectLongSoldier(px + 68, py, 4, total - amount(0))
        End If
    Else 
        amount(0) = selectLongSoldier(px, py, firstSltMode, total)
        If amount(0) < total Then
            amount(1) = selectLongSoldier(px+68, py, 4, total - amount(0))
        End If
    End If
	
    //verify
    Dim actualArmy = readActualArmy(basePx, basePy, 2)
    Dim actualTotal = 0
    For i = 0 To UBOUND(actualArmy)
        actualTotal = actualTotal + actualArmy(i)
    Next
	
    selectAtkSoldier = actualTotal
    //TracePrint "select result: " & actualTotal
end Function


Function selectLongSoldier(px, py, mode, total)
    //TracePrint "selectLongSoldier"

    selectLongSoldier = selectSoldierNum(px, py, armyAtkLongImages, mode, total, true)

End Function

Function selectShortSoldier(px, py, mode, total)
    //TracePrint "selectShortSoldier"	
    selectShortSoldier = selectSoldierNum(px, py, armyAtkShortImages, mode, total, false)
End Function

Function selectCannonSoldier(basePx, basePy)
    //Dim m = EmpireOcr.ocrNumber(270, 324, 320, 332)
    //TracePrint "selectCannonSoldier"
    Dim px=basePx,py=basePy+80
	
    //retry 3
    //For i = 0 To 2    
    Dim result = selectSoldierNum(px, py, armyCannonImages, 1, 1, true)
		
    If result = 0 Then 
        Dim img = armyArray(42, ARMY_PIC_ATK) & "|" & armyArray(102, ARMY_PIC_ATK)
        selectCannonSoldier = selectSoldierNum(px, py, img, 1, 1, true)
        //Exit For
    End If
	
    //verify
    Dim actualArmy = readActualArmy(basePx, basePy, 1)
    selectCannonSoldier = actualArmy(0)
    //If actualArmy(0) > 0 Then 
    //	Exit For
    //End If
    //Next
End Function

Function selectSoldierNum(px, py, soldierImages, mode, total, isLong)
    //TracePrint "[selectSoldierNum] px,py=> " & px & "," & py & ", " & soldierImages & "," & total 
	If total = 0 Then 
    	TracePrint "select zero."
    	selectSoldierNum=0
    	Exit Function
    End If
      
    Dim result,value
    For i = 0 To 2
			
        Delay DELAY_OPERATE_RANK(0)
        tapPosition px, py
        Delay DELAY_OPERATE_RANK(1)
		
        result = selectSoldierNum2(soldierImages, mode, cInt(total), isLong)
        //TracePrint "selxx" & result
		
        Delay DELAY_OPERATE_RANK(0)
		
        //KeepCapture
        actionConfirm()
        Delay DELAY_OPERATE_RANK(0)
		
        //exception
        FindPicFull "Attachment:op_confirm.png"
        If intX > -1 And intY > -1 Then 
            FindPicFull soldierImages
            Tap intX+10, intY+10
            actionConfirm()
        End If
        //ReleaseCapture
		
        Delay DELAY_OPERATE_RANK(0)
		
        //实际值为0则退出
        value = CInt(EmpireOcr.ocrNumber(px-10,py+10,px+10, py+17))
        If value <> result Then 
            TracePrint "result is not same: result:"&result&",value:"&value
        End If
		
        selectSoldierNum = value
        //TracePrint "实际校验值：" & value & "<<" & px & "," & py
        If result=0 or value <> 0 Then 
            Exit For
        End If
    Next
	
    If value = 0 Then 
        TracePrint "selectSoldierNum : [" & mode & "]," & soldierImages & "," & total 
    End If
	
End Function

//mode[1:single, 2:half, 3:half-all, 4:all]
Function selectSoldierNum2(soldierImages, mode, total, isLong)	
    //TracePrint "select Soldier:" & mode & "," & total & ",pic: " & soldierImages
	
    If isLong Then 
        tapPosition 340, 270
        Delay DELAY_OPERATE_RANK(1)
    Else
        tapPosition 140, 270
        Delay DELAY_OPERATE_RANK(1)
    End If
	
    Dim result = 0, startX=35, startY=320, lastX=35, lastY
	
    Delay DELAY_OPERATE_RANK(0)
    CommUtil.capKeepMem(0)
    //Delay DELAY_OPERATE_RANK(0)
    For i = 1 To 60
        Dim num = 0
        Dim idx = FindPicArea2(startX, startY, 140, 650, "Attachment:select_0_mask.png")
        //TracePrint "startX,startY=>" & startX & "," & startY & ", intX,intY=>"  & intX & "," & intY & "," & idx
        If intX = -1 or intY = -1 Then 
            FindPicArea2(300, 600, 375, 750, "Attachment:select_0_end.png")
            If intX > -1 And intY > -1 Then 
                TracePrint "底部"
                Exit For
            End If
			
            //Y:army：250(最顶部可见位置)，tool：300			
            //TracePrint "Tap Move: " & 372-(lastY+129)
			
			//from lastY+129 -> 135,372
            dragMove 135, 600, 0, 372-(lastY+129)
            Delay DELAY_OPERATE_RANK(0)
			
            //一格空间
            startY = 372
			
            CommUtil.capKeepMem(1)
        Else 
            //lastX = intX
            lastY = intY
			
			
            FindPicArea2 lastX, lastY, 145, lastY + 100, soldierImages
            //TracePrint "findSoldier x,y:" & intX & "," & intY
            If intX > -1 And intY > -1 Then
                Dim baseX = intX, baseY=intY
				
                //数字相对坐标：220，17，280，25
                Dim str = EmpireOcr.ocrNumber(baseX+220, baseY+19, baseX+280, baseY+30)
				
				
                Dim iAmount = CInt(str)
                //TracePrint "m:" & str & ", iAmount:" & iAmount & ", mode" & mode
				
				
                If mode = 1 Then 
                    //one
                    num = 1
                ElseIf mode = 2 Then
                    //only total/2
                    If iAmount >= total / 2 Then 
                        num = total / 2
                    End If
                ElseIf mode = 3 Then
                    //total/2 - total
                    If iAmount >= total / 2 Then 
                        num = iAmount
                    End If
                ElseIf mode = 4 Then
                    //full
                    If iAmount >= total Then 
                        num = iAmount
                    End If
                ElseIf mode = 5 Then
                    //only total
                    If iAmount >= total Then 
                        num = total
                    End If
                ElseIf mode = 6 Then
                    If total < iAmount Then 
                        num = total
                    Else 
                        num = iAmount
                    End If
                End If
				
                //TracePrint "check condition:"&num
                If num = 1 Then 
                	tapPosition baseX + 370, baseY + 30
                	result = num
                    Exit For
                ElseIf num = iAmount And num <> 0 Then
                	tapPosition baseX + 120, baseY + 30
                    result = num
                    Exit For
                ElseIf num > 0 Then
                    //116，38，  248，38   379，38 【264】
                    //Y1=176,Y2=322
					
                    Dim moveX = 146 / (iAmount/num)
                    Dim fixedMoveX = moveX
                    //TracePrint "xxx:" & moveX
					
                    If moveX < 10 Then 
                        tapPosition baseX + 118 + 20, baseY + 38
                    ElseIf moveX > 145 Then
                        //TracePrint "More than 262 : " & moveX
                        fixedMoveX = 147
                    End If
					
                    //TracePrint "select data [" & num & "," & moveX & "," & baseX + 118 + CInt(moveX)
                    //相对位置176，38
                    Dim sltX = baseX + 176 + CInt(fixedMoveX)
                    Dim sltY = baseY + 38
					
                    //Delay 100
                    //tapPosition baseX + 118 + CInt(moveX), baseY + 38
					
                    If num < 100 or moveX <= 145 Then 
                        tapPosition sltX, sltY
                    Else
                        TouchDown sltX, sltY
                        TouchMove sltX+2, sltY
                        TouchUp 
                        Delay DELAY_OPERATE_RANK(0)
                    End If
                    Delay DELAY_OPERATE_RANK(1)
					
                    result = num
                    Exit For
                End If
            End If
			
			//>0 < 129
            startY = lastY + 129
        End If
    Next
    CommUtil.capRealseMem

    selectSoldierNum2 = result
    //TracePrint "select result: " & result
End Function

Function readLevel(baseX, baseY)
    //-36,-54
    tapPosition(baseX-36, baseY-54)
    readLevel = EmpireOcr.ocrNumber(290, 282, 305, 291)
    //Dim readUpdate = EmpireOcr.ocrNumber(200, 296, 230,307)
    //TracePrint "xxxxxx:" & readUpdate
	
    clearPopWindow 
	
    //-135,-60 target
    tapPosition(baseX-135,baseY+60)
End Function

Function selectTarget(x, y)
    tapPosition 48, 32
    Delay DELAY_OPERATE_RANK(2)
    If isDisConnect() Then 
        selectTarget = -1
        Exit Function
    End If
	
    tapPosition 160, 210
    //TracePrint "start input" & CStr(x)
    //InputText x
    inputContent2("del,del,del,del")
    inputContent(CStr(x))
	
    //TracePrint "middle input"
    tapPosition 270, 210
    //InputText y
    inputContent2("del,del,del,del")
    inputContent(CStr(y))
    //TracePrint "end input"& CStr(y)
	
    Delay DELAY_OPERATE_RANK(0)
    tapPic ("Attachment:map_icon_main.png")
	
    selectTarget = 0
End Function


Function readBase()
    //基准位置
    Delay 100
    FindPicFull "Attachment:bat_target_center.png"
    If intX > 0 And intY > 0 Then 
        baseX = intX + 18
        baseY = intY + 18
        readBase = 0
    Else 
        TracePrint "未找到基准点"
        readBase = -1
    End If
End Function

//10:cancle, 12:start doing, 13:alread doing 15:done,
Function spyTarget(baseX, baseY, targetData, canSpy)
    //TracePrint "Spy target: [" & baseX & "," & baseY &"],[" & Join(targetData, ",") & "]"
		
    If targetData(TAGT_SPY) = 15 Then 
        Exit Function
    End If
	
	If targetData(TAGT_TYPE)=1 And targetData(TAGT_LVL) = 51 Then 
		targetData(TAGT_SPY) = 15
		Exit Function
	End If
	
    If not (canSpy) And targetData(TAGT_SPY) = 10 Then 
        Exit Function
    End If
		
    If targetData(TAGT_SPY) = 12 And Time() < targetData(TAGT_SPY_T) Then 
        //执行中
        Exit Function
    End If
		
    //游牧低于20级不侦查 targetData(TAGT_TYPE)=11 and
    If targetData(TAGT_LVL) < 20 and targetData(TAGT_LVL) > 0 Then
        targetData(TAGT_SPY) = 15
        Exit Function
    End If
		
/*
		//正在侦查(大于5分钟后，检查)
		If targetData(TAGT_SPY) >= 12 Then 
			targetData(TAGT_SPY) = 13
			//5 minute 不变更
			If Time()-targetData(TAGT_SPY_T) > 5*MINUTE_ONE Then 
				Exit Function
			End If
		End If
*/
    //-128, 65;-113,80: wushi:-133,62,-118,76
    FindPicArea2 baseX-135, baseY+60, baseX-113, baseY+80, "Attachment:bat_spy_over.png"
    If intX > 0 And intY > 0 Then 
        targetData(TAGT_SPY) = 15
        TracePrint "已经侦查"
        Exit Function
    ElseIf canSpy
        tapPosition baseX - 16, baseY + 128
        spyAlloc (targetData)
        TracePrint "Spy result: " & Join(targetData, ",") & "]"
    Else 
        //可能侦查失败
        targetData(TAGT_SPY) = 10
    End If
End Function

Function spyAlloc(targetData)
    //KeepCapture
    //预估成功率

    Dim finishRatio = EmpireOcr.ocrNumber(198,573,218,586)
    //TracePrint "完整度:" & finishRatio
    //ReleaseCapture
	
    If finishRatio <> "100" Then 
		
        //Tap 380, 503
        dragMove(350,503, 40, 0)
        finishRatio = EmpireOcr.ocrNumber(198, 573, 218, 586)
		If finishRatio <> "100" Then 
			TracePrint "[ERROR] not reset spy success ratio to 100%."
		End If
    End If
	
    Dim failRatio = EmpireOcr.ocrNumber(298,573,314,586)
    //TracePrint "失败率:" & failRatio
    Dim ratio = CInt(failRatio)
	
    If finishRatio = "" or failRatio = "" Then 
        spyAlloc = 10
        Exit Function
    End If
	
    If ratio < SPY_SUC_RATE+4 Then 
        If ratio < SPY_SUC_RATE Then 
            Dim oneMode = False
            Do While True
                If ratio > SPY_SUC_RATE Then 
                    tapPosition(220, 440)
                    oneMode = True
                ElseIf oneMode Then
                    Exit Do
                ElseIf ratio < 5 Then
                    tapPositionTimes(65, 440, 6)
                ElseIf ratio < SPY_SUC_RATE-4 Then
                    tapPositionTimes(65, 440, 3)
                ElseIf ratio < SPY_SUC_RATE Then
                    tapPosition(65, 440)
                Else 
                    Exit Do
                End If
				
                Delay DELAY_OPERATE_RANK(0)
                failRatio = EmpireOcr.ocrNumber(298, 573, 314, 586)
                If failRatio = "" Then 
                    //avoid dead loop
                    spyAlloc = 10
                    Exit Function
                End If
				
                ratio = CInt(failRatio)
            Loop	
        End If
		
        //TracePrint "执行计划:" & failRatio
        actionConfirm()
		
        Dim atkTimeStr = EmpireOcr.ocrNumber2(230, 192, 285, 205, 2)
        actionConfirm
		
        Dim spyIimeInS = CommUtil.formatTime(atkTimeStr)
        If spyIimeInS = 0 Then 
            TracePrint "[ERROR] can not read attack time. " & Now()
            spyIimeInS = 5 * 60
        End If
		
        actionConfirm 
		
        targetData(TAGT_SPY) = 12
        targetData(TAGT_SPY_T) = Time() + spyIimeInS
		
        spyAlloc = 12
    Else
        TracePrint "取消计划:" & failRatio
        actionCancle 
        spyAlloc = 10
    End If
	
End Function


///////////////////////////////////////////////////////////////////////////////////////
//
//公共方法
//
///////////////////////////////////////////////////////////////////////////////////////

//全图搜图
Function FindPicFull(image)
    FindPicFull = FindPic( 0, 0, 0, 0, image, "080808", 0, 0.9, intX, intY)
End Function
//区域搜图
Function FindPicArea(x, y, image)
    FindPicArea=FindPic( x, y, screenX, screenY, image, "080808", 0, 0.9,intX,intY)
End Function

Function FindPicArea2(x1, y1, x2, y2, image)
    FindPicArea2 = FindPic(x1, y1, x2, y2, image, "101010", 0, 0.9, intX, intY)
    If intX = -1 or intY = -1 Then 
        //TracePrint "FindPicArea2, can not find: " & image & " from[" & x1 & "," & y1 & ";"& x2 & "," & y2
    End If
End Function

Function actionConfirm
    tapPic "Attachment:op_confirm.png"
End Function

Function actionCancle
    tapPic "Attachment:op_cancle.png"
End Function

Function tapPic(picPath)
    tapPic = False
    FindPicFull picPath
    If intX > 0 And intY > 0 Then 
        tapPic = True
        Tap intX, intY
        Delay DELAY_OPERATE_RANK(0)
    Else 
        TracePrint "Can not click image: " & picPath
    End If
End Function

Function tapPicArea(x1, y1, x2, y2, images, delayTime)
    tapPicArea = False
    FindPic x1, y1, x2, y2,  images, "101010",0, 0.8, intX, intY
    If intX > 0 And intY > 0 Then 
        tapPicArea = True
        Tap intX, intY
        Delay delayTime
    Else 
        TracePrint "Can not click image: " & images
    End If
End Function

Function tapPic2(imgArray, delayTime)
    tapPic2 = True
    For Each pic In imgArray
        FindPicFull pic
        If intX > 0 And intY > 0 Then 
            Tap intX, intY
            Delay delayTime
        Else 
            tapPic2 = False
            TracePrint "Can not click image: " & pic
            Exit For
        End If	
    Next
End Function

Function tapMenuMoveLeft(moveTimes)
	For i = 1 To moveTimes
		Delay DELAY_OPERATE_RANK(0)
    	tapPosition 464, 750
	Next

    Delay DELAY_OPERATE_RANK(1)
End Function

Function tapMenuReset
	tapPosition 16, 750
    tapPosition 16, 750
    Delay DELAY_OPERATE_RANK(0)
End Function

Function tapMenuAndTry(menuList, delayTime)
	Dim result, TRY_TIMES = 3
	Dim tapFlag = True
	
	TracePrint "Tap menu list: " & Join(menuList, ",")
	For i = 1 To TRY_TIMES
    	For Each menuPic In menuList
        	TracePrint "debug:" & menuPic
        	result = PictureUtil.findPicHalfBottom(menuPic, intXY)
        	If result >= 0 Then 
            	Tap intXY(X)+10, intXY(Y)+10
            	Delay delayTime
        	Else 
            	tapFlag = False
            	TracePrint "Can not click image: " & menuPic
            	Exit For
        	End If	
    	Next
    	
    	If tapFlag = false and i < TRY_TIMES Then 
    		TracePrint "Retry tap menu. "
    		clearPopWindowNoReset 
    		tapFlag = True
    	Else 
    		//Exit for 只能退出本层
    		Exit For
    	End If
	Next
	
	tapMenuAndTry = tapFlag
End Function

Function tapPosition(x, y)
    tapPositionTimes(x, y, 1)
End Function

Function tapPosition2(x, y, delayTime)
    tapPositionTimes x, y, 1
    Delay delayTime
End Function

Function tapPositionTimes(x, y, times)
    For i = 1 To times
        Tap x, y
        delay DELAY_OPERATE_RANK(0)
    Next
	
    //TracePrint "tap:" & x & "," & y
    Delay DELAY_OPERATE_RANK(0)
End Function



Function inputContent(content)
    For i = 1 To len(content)
        Dim ch = Mid(content, i,1)
        Select Case ch
        Case "0"
            KeyPress "0"
        Case "1"
            KeyPress "1"
        Case "2"
            KeyPress "2"
        Case "3"
            KeyPress "3"
        Case "4"
            KeyPress "4"
        Case "5"
            KeyPress "5"
        Case "6"
            KeyPress "6"
        Case "7"
            KeyPress "7"
        Case "8"
            KeyPress "8"
        Case "9"
            KeyPress "9"
        End Select
    Next
End Function

Function inputContent2(content)
    Dim arr = Split(content, ",")
    For i = 0 To UBOUND(arr)
        KeyPress arr(i)
    Next	
End Function
//==============================================================================================
//侦查信息读取： 5+2+2
//==============================================================================================
Function readEnimyInfo(btlType)
    //找项目读取
    dim lastX=0, lastY=134
    dim i=0, value, cityDefValue = Array(9)

    CommUtil.capKeepMem(0)
	
    do while i<=4
        Call FindPicFull(cityDefenceInfo(i))
        If intX > 0 And intY > 0 Then 
            lastX = intX
            lastY = intY
            //value = EmpireOcr.ocrNumber(intX, intY+18, intX+52, intY+28+20)
            value = EmpireOcr.ocrNumber(intX, 157, intX+52, 170)
            If value <> "" Then
                cityDefValue(i) = CInt(value)
            Else 
                cityDefValue(i) = -1
            End If
        Else 
            cityDefValue(i) = -1
        End If
		
        //TracePrint "基础防御：[" & cityDefenceInfo(i) & "]" & cityDefValue(i)
        i=i+1
    loop
	
    //标注距离：56， 初始距离38
    lastX = lastX + 38
    Dim endX = screenX
	
    Delay DELAY_OPERATE_RANK(0)

    //army动态读取
    Dim size = 0, cityDefArmyValue = Array(20)
    Dim armyType, leftClickTimes=0, index
	
    Dim logInfo = "Army Info => "
	
    Do While true
        Call FindPic(lastX,170,endX,176,"Attachment:battle_enemy_info_buttom.png","080808", 0, 0.9, intX, intY)
        If intX > 0 and intY > 0 Then 
            lastX = intX+56
		
            //类别，数字
            //数字：宽度56，14像素
            //图标：宽度56，44像素
            value = EmpireOcr.ocrNumber(intX, 157, intX+52, 170)
		 	
            //land1DefImage,land1DefImage
            //TracePrint "识别类型:[" & intX & "," & intY & "] => " & type & "," & dfArmyImage(type)
            index = FindPic(intX,intY-58,intX+56,intY-14,armyDefImagesArray(btlType),"080808", 0, 0.9, intX, intY)
            //value = EmpireOcr.ocrNumber(intX, intY-16, intX+52, intY)
		 	
            If index = -1 Then
                armyType = -1
                cityDefArmyValue(size) = Array(-1, value)
                //TracePrint "Army Info：[ -1 未知]" & value
                logInfo = logInfo & "[ -1 未知:" & value & "], "
            Else
                armyType = armyArray(index,ARMY_ID)
                cityDefArmyValue(size) = Array(armyType, value)
                //TracePrint "Army Info：[" & armyType & armyArray(armyType,0) & "]" & value
                logInfo = logInfo & "[" & armyType & armyArray(armyType,ARMY_NAME) & ":" & value & "],"
            End If
		 	
            size = size + 1
        Else
            //是否有滑动按钮
            //441,130;460,160
            Call FindPic(441, 130, 460, 160, "Attachment:battle_enemy_left_arrow.png", "080808", 0, 0.9, intX, intY)
            If leftClickTimes < 5 and intX > 0 and intY > 0 Then 
                leftClickTimes = leftClickTimes+1
                Tap intX + 5, intY + 10
                Delay DELAY_OPERATE_RANK(2)
				
                CommUtil.capKeepMem(1)
				
                Dim tmpFlag = True
                If armyType > -1 Then 
                    //TracePrint "DEBUG  1111"
                    //36,114;441,157
                    Call FindPic(36, 114, 441, 157, armyDefImagesArray(armyType), "080808", 0, 0.9, intX, intY)
                    If intX > 0 and intY > 0 Then 
                        //TracePrint "DEBUG  22222"
                        tmpFlag = False
                        lastX = intX + 56
                    End If
                End If
				
                If tmpFlag Then 
                    //36,170,460,176
                    lastX = 36
                End If
				
                TracePrint "DEBUG ：[" & lastX & "," & lastY & "]"
                //TracePrint "DEBUG ：[" & endX & "," & endY & "]"
				
            Else
                Exit Do
            End If
        End If
    Loop
	
    //基础
    //cityDefValue:5,6
    cityDefValue(DF_PW_SHORT) = 0
    cityDefValue(DF_PW_LONG) = 0
    cityDefValue(DF_NUM_SHORT) = 0
    cityDefValue(DF_NUM_LONG) = 0
    For i = 0 To size - 1
        if cityDefArmyValue(i,0) <> -1 And cityDefArmyValue(i,1) <> "" then
            cityDefValue(DF_PW_SHORT) = cityDefValue(DF_PW_SHORT) + cInt(cityDefArmyValue(i,1)) * armyArray(cityDefArmyValue(i, 0), ARMY_DF_S)
            cityDefValue(DF_PW_LONG) = cityDefValue(DF_PW_LONG) + CInt(cityDefArmyValue(i, 1)) * armyArray(cityDefArmyValue(i, 0), ARMY_DF_L)
			
            If armyArray(cityDefArmyValue(i, 0), ARMY_ATK_S) > 0 Then 
                cityDefValue(DF_NUM_SHORT) = cityDefValue(DF_NUM_SHORT) + cInt(cityDefArmyValue(i,1))
            End If
			
            If armyArray(cityDefArmyValue(i, 0), ARMY_ATK_L) > 0 Then 
                cityDefValue(DF_NUM_LONG) = cityDefValue(DF_NUM_LONG) + cInt(cityDefArmyValue(i,1))
            End If
			
        Else
            cityDefValue(DF_PW_SHORT) = -1
            cityDefValue(DF_PW_LONG) = -1
            Exit For
        End If
    Next
	
    CommUtil.capRealseMem 
	
    TracePrint "基础能力：" & Join(cityDefValue, ",") & "; " & logInfo
	
    readEnimyInfo = cityDefValue
End Function

//============================================================================================
// army infomation
//============================================================================================
Dim ARMY_ID=0,ARMY_NAME=1,ARMY_PIC=2,ARMY_ATK_S=3,ARMY_ATK_L=4,ARMY_DF_S=5,ARMY_DF_L=6,ARMY_PIC_ATK=7,ARMY_PIC_DEF=8
Function loadArmyInfo(atkArmyCfg)
	Dim armyStrArray = loadArmyCfgData()
    Dim totalArmyStr = Join(armyStrArray, "#")
    TracePrint "Load army info: " & totalArmyStr
    
    armyArray = Array(120)
    For i = 0 To 120
    	armyArray(i) = Array(0,0,0,0,0,0,0,0,0)
    Next
    
    Dim tmpD1Str = Split(totalArmyStr, "#")
    Dim tmpD2,idx
    
    For i = 0 To UBOUND(tmpD1Str)
        tmpD2 = Split(tmpD1Str(i), ",")
        
        //类型转换
        If UBOUND(tmpD2) < 6 Then 
        	TracePrint("invalid configuration : " & tmpD1Str(i))
        	Exit Function
        End If
        
        idx = CInt(tmpD2(0))
        armyArray(idx) = Array(9)
        armyArray(idx, ARMY_ID) = idx
        armyArray(idx, ARMY_NAME) = tmpD2(ARMY_NAME)
        armyArray(idx, ARMY_PIC) = tmpD2(ARMY_PIC)
        armyArray(idx, ARMY_ATK_S) = CInt(tmpD2(ARMY_ATK_S))
        armyArray(idx, ARMY_ATK_L) = CInt(tmpD2(ARMY_ATK_L))
        armyArray(idx, ARMY_DF_S) = CInt(tmpD2(ARMY_DF_S))
        armyArray(idx, ARMY_DF_L) = CInt(tmpD2(ARMY_DF_L))
        armyArray(idx, ARMY_PIC_ATK) = "Attachment:select_" & tmpD2(ARMY_PIC) & ".png"
        armyArray(idx, ARMY_PIC_DEF) = "Attachment:battle_enemy_" & tmpD2(ARMY_PIC) & ".png"
        
        //TracePrint "xxx:" & Join(armyArray(idx), ",") 
    Next

    //-----------------------------------------------------------
    //defence army configuration
    dim DEF_ARMY_ARRAY = Array(20)
    DEF_ARMY_ARRAY(0) = Array(1,2,3,4,5,6,7,8,9,10,11,21,22,23,24)
    DEF_ARMY_ARRAY(1) = Array(11,51,52)
    DEF_ARMY_ARRAY(2) = Array(11,53,54)
    DEF_ARMY_ARRAY(3) = Array(11,55,56)
    DEF_ARMY_ARRAY(11) = Array(77, 78)
	
	armyDefImagesArray = Array(20)
	For i = 0 To 20
		If IsArray(DEF_ARMY_ARRAY(i)) Then 
			armyDefImagesArray(i) = parseArmyCfg(DEF_ARMY_ARRAY(i), false)
			TracePrint "[TYPE  " & i & "]:" & armyDefImagesArray(i)
		Else 
			armyDefImagesArray(i) = ""
		End If
	Next
	    
	//attack army infomation
	armyAtkShortImages = parseArmyCfg(atkArmyCfg(0), true)
	armyAtkLongImages = parseArmyCfg(atkArmyCfg(1), true)
	
	TracePrint "Attack Long:" & armyAtkLongImages
    TracePrint "Attack Short:" & armyAtkShortImages
End Function

Function parseArmyCfg(data, isAtk)
	//TracePrint "parseArmyCfg:" & Join(data, ",") & "," & CStr(isAtk)
	
	Dim tmpStr = "",pos=0
	
	Dim prefixAtk = "Attachment:select_",prefixDef = "Attachment:battle_enemy_"
	Dim prefix = prefixDef
	If isAtk Then 
		prefix = prefixAtk
	End If
	
	For index = 0 To UBOUND(armyArray)
		If pos > UBOUND(data) Then 
			Exit For
		End If
		
		If armyArray(index, ARMY_ID) = 0 Then 
			tmpStr = tmpStr & " |"
		Else
			While armyArray(index, ARMY_ID) > data(pos)
				pos = pos + 1
				If pos >= UBOUND(data) Then 
					Exit While
				End If
			Wend
			
			If armyArray(index, ARMY_ID) = data(pos) Then 
				tmpStr = tmpStr & prefix & armyArray(index, ARMY_PIC) & ".png|"
				pos = pos + 1
			Else
				tmpStr = tmpStr & " |"
			End If
		End If
	Next
	parseArmyCfg = tmpStr
End Function

Function loadTowerParam
    brigandsCmd = Array(8)
    brigandsCmd(0) = Array(0, 0, 0, 15, 15)
    brigandsCmd(1) = Array(0, 0, 0, 19, 19)
    brigandsCmd(2) = Array(16, 0, 0, 19, 19)
    brigandsCmd(3) = Array(16, 15, 0, 19, 20)
    brigandsCmd(4) = Array(20, 19, 0, 25, 26)
    //50
    brigandsCmd(5) = Array(20, 19, 0, 25, 26)
    brigandsCmd(6) = Array(30, 27, 0, 36, 38)
    brigandsCmd(7) = Array(40, 35, 0, 47, 50)	
    brigandsCmd(8) = Array(40, 35, 0, 47, 50)
	
    //
    brigandsTower = Array(4)
    brigandsTower(0) = Array(4)
    //level, wall, door, Akt_TIME(C), ATK_TIME(S), cannon
    brigandsTower(0, 0) = Array(10, 20, 20, 1, 1, 0)
    brigandsTower(0, 1) = Array(23, 40, 40, 1, 2, 1)
    brigandsTower(0, 2) = Array(49, 60, 60, 2, 2, 1)
    brigandsTower(0, 3) = Array(69, 60, 60, 2, 2, 2)
    brigandsTower(0, 4) = Array(100, 60, 60, 3, 4, 0)
    brigandsTower(1) = Array(1)
    brigandsTower(1, 0) = Array(49, 40, 40, 1, 2, 1)
    brigandsTower(1, 1) = Array(100, 60, 60, 1, 2, 2)
    brigandsTower(2) = Array(1)
    brigandsTower(2, 0) = Array(49, 60, 60, 1, 2, 1)
    brigandsTower(2, 1) = Array(100, 60, 60, 1, 2, 2)
    brigandsTower(3) = Array(1)
    brigandsTower(3, 0) = Array(49, 60, 60, 1, 2, 1)
    brigandsTower(3, 1) = Array(69, 60, 60, 1, 2, 2)
    brigandsTower(3, 2) = Array(90, 60, 60, 1, 1, 3)
End Function


//============================================================================================
// attack army configuration
//============================================================================================
Dim armyAtkArray, armyHsptRtn, armyCannonFodder, twMapArray, twNomads, twSamurai, twForeign, cmdArgs
Function init
    cityDefenceInfo = Array(6)
    cityDefenceInfo(0) = "Attachment:bat_def_wall.png"
    cityDefenceInfo(1) = "Attachment:bat_def_door.png"
    cityDefenceInfo(2) = "Attachment:bat_def_river.png"
    cityDefenceInfo(3) = "Attachment:bat_def_long.png"
    cityDefenceInfo(4) = "Attachment:bat_def_short.png"
	
	atkWavesMark = Array("Attachment:bat_atk_waves_1_1.png|Attachment:bat_atk_waves_1_2.png","Attachment:bat_atk_waves_2_1.png|Attachment:bat_atk_waves_2_2.png","Attachment:bat_atk_waves_3_1.png|Attachment:bat_atk_waves_3_2.png","Attachment:bat_atk_waves_4_1.png|Attachment:bat_atk_waves_4_2.png")

	//============================================================================================
	// attack army configuration
	//============================================================================================
	armyAtkArray = Array(2)
	armyAtkArray(0) = Array(41,51,53,55,61,75,101,103,105)
	armyAtkArray(1) = Array(42,52,54,56,62,76,102,104,106)
	
	//hospital remained
	armyHsptRtn = Array(41, 42, 101, 102, 103, 104)
	
	//cannon fodder
	armyCannonFodder = Array(2, 4)
	
	twNomads = "-1,0,0,0"
	twSamurai = "-1,0,0,0"
	twForeign = "-1,0,0,0"
	
	twMapArray = Array(7)
	For i = 0 To 6
		twMapArray(i) = "-1,0,0,0"
	Next
	
	cmdArgs = "##########"
	
	//============================================================================================
	//load gloabal configuration
	loadGlobalConfig()
	
	//============================================================================================
	loadArmyInfo(armyAtkArray)
    TracePrint "加载军队信息:" & CommUtil.Join2DimArray(armyArray)
    
    Dim hostpitalRetainArmy = Array(7)
    hostpitalRetainArmy(0) = armyHsptRtn
    hostpitalRetainArmy(1) = armyHsptRtn
    hostpitalRetainArmy(2) = armyHsptRtn
    hostpitalRetainArmy(3) = armyHsptRtn
    hostpitalRetainArmy(4) = CommUtil.sortArray(CommUtil.mergeArray(armyHsptRtn, Array(51, 52)))
    hostpitalRetainArmy(5) = CommUtil.sortArray(CommUtil.mergeArray(armyHsptRtn, Array(53, 54)))
    hostpitalRetainArmy(6) = CommUtil.sortArray(CommUtil.mergeArray(armyHsptRtn, Array(55, 56)))
	TracePrint Join(hostpitalRetainArmy(6), ",")

    armyHsptRtnImagesArray = Array(7)
	For i = 0 To 6
		armyHsptRtnImagesArray(i) = parseArmyCfg(hostpitalRetainArmy(i), true)
		TracePrint armyHsptRtnImagesArray(i)
	Next
    //TracePrint "Hospital remain army: " & Join(armyHsptRtnImagesArray, ",")
    
    armyCannonImages = parseArmyCfg(armyCannonFodder,true)
    TracePrint "Cannon army: " & armyCannonImages
		
	//============================================================================================
	Dim landTowers = Join(twMapArray, "#")
    targetArray = CommUtil.split2DimArray(landTowers)
    CommUtil.extend2DArray(targetArray, 9)
    TracePrint "加载Tower信息:" & CommUtil.Join2DimArray(targetArray)
	
	//============================================================================================
    nomadsTowerArray = CommUtil.split2DimArray(twNomads)
    CommUtil.extend2DArray nomadsTowerArray, 9
    TracePrint "活动1地点:" & CommUtil.Join2DimArray(nomadsTowerArray)
	
	
	//============================================================================================
    samuraiTowerArray = CommUtil.split2DimArray(twSamurai)
    CommUtil.extend2DArray samuraiTowerArray, 9
    TracePrint "活动2地点:" & CommUtil.Join2DimArray(samuraiTowerArray)
	
	
	//============================================================================================
    foreignTowerArray = CommUtil.split2DimArray(twForeign)
    CommUtil.extend2DArray foreignTowerArray, 9
    TracePrint "活动3地点:" & CommUtil.Join2DimArray(foreignTowerArray)
	
    If gCampaignType = 1 Then 
        curCampaignTowerArray = nomadsTowerArray
    ElseIf gCampaignType = 2 Then	
        curCampaignTowerArray = samuraiTowerArray
    ElseIf gCampaignType = 3 Then	
        curCampaignTowerArray = foreignTowerArray
    End If
	
	//============================================================================================
    //wall,door,river,long, short, center+, side+
    //cmdArgs = "69,0,57#85,40,45#70,0,60#"
    commanderArray = CommUtil.split2DimArray(cmdArgs)
    CommUtil.extend2DArray commanderArray, 7
    TracePrint "指挥官属性:" & CommUtil.Join2DimArray(commanderArray)
	
	//加载 tower 参数 ..
	loadTowerParam()
End Function

Dim cdToolsEnable,cdToolsTime,cdExeTimes,ymCenterToolTimes=1,ymAtkTimes
Function loadCdToolCfg
	//24h, 5h, 1h, 30m, 10m, 5m, 1m
	cdToolsEnable = Array(false, true, true, true, true, true) 
	cdToolsTime = Array(18000,14000,7200,3000,1200)
	cdExeTimes=40
	ymCenterToolTimes = 2,ymAtkTimes=4
End Function

Function loadArmyCfgData
	Dim armyStrArray = Array(8)
    armyStrArray(0) = "1,长枪兵,spearman,26,0,26,8#2,木弓箭手,woodbow,0,24,8,24#3,链锤兵,maceman,38,0,38,6#4,弩箭手,crossbow,0,36,6,36#5,长斧兵,halberdier,17,0,135,45#6,长弓射手,longbowman,0,20,51,125#7,重剑手,swordsman_heavy,109,0,19,5#8,重弩箭手,crossbow_heavy,0,92,15,24#9,剑客,swordsman,61,0,5,3#10,铁弓箭手,ironbow,0,10,53,55#11,民兵,militias,3,0,9,9#12,高级民兵,militias_ad,10,0,10,10"
    armyStrArray(1) = "21,高级长枪兵,spearman_ad,15,0,142,52#22,高级木弓箭手,woodbow_ad,0,18,59,132#23,高级链锤兵,maceman_ad,118,0,20,6#24,高级弩箭手,crossbow_ad,0,98,16,26#25,高级重剑手,swordsman_heavy_ad,125,0,20,6#26,高级重弩箭手,crossbow_heavy_ad,0,114,16,26"
    armyStrArray(2) = "41,皇家骑士,royal_knight,132,0,18,5#42,皇家弩箭手,royal_crossbow,0,121,14,23"
    armyStrArray(3) = "51,冰川勇士,ice_short,103,0,129,41#52,冰川弓箭手,ice_long,0,86,48,119#53,沙漠勇士,desert_short,109,0,135,45#54,沙漠弓箭手,desert_long,0,92,51,125#55,火山勇士,volcano_short,109,0,135,45#56,火山弓箭手,volcano_long,0,92,51,125"
    armyStrArray(4) = "61,行游骑士,travel_knight,146,0,20,9#62,行游弩箭手,travel_crossbow,0,135,22,30#63,恶魔勇士,demon_warrior,185,0,19,5#64,高级恶魔勇士,demon_warrior_ad,200,0,21,6#65,地狱勇士,hell_warrior,0,162,15,24#66,高级地狱勇士,hell_warrior_ad,0,175,17,26"
    armyStrArray(5) = "71,剃刀手,razor,139,0,6,3#72,高级剃刀手,razor_ad,149,0,20,15#73,弹弓手,trigger,0,130,5,9#74,高级弹弓手,trigger_ad,0,139,19,24#75,叛军勇士,rebel_warrior,160,0,20,7#76,叛军投箭手,rebel_darts,0,148,18,27#77,长毛轻骑兵,nomads_cavalry,13,0,150,34#78,掷抢手,nomads_spearman,0,14,35,139#79,叛军武士,rebel_def_short,14,0,165,61#80,叛军弓箭大师,rebel_def_long,0,16,66,153"
    armyStrArray(6) = "101,皇家禁卫,royal_b_knight,135,0,21,8#102,皇家木弓手,royal_b_crossbow,0,124,17,26#103,皇家骑士A,royal_a_knight,143,0,21,8#104,皇家神射手,royal_a_crossbow,0,132,17,26#105,B战武士,berimond_short,116,0,142,52#106,B战射手,berimond_long,0,97,59,132#107,刀锋武士,blade_short,109,0,135,45#108,刀锋弓箭手,blade_long,0,92,51,125"
    armyStrArray(7) = "111,冰霜近战1,frost_s1,109,0,135,45#112,冰霜远程1,frost_l1,0,92,51,125#113,冰霜近战2,frost_s2,109,0,135,45#114,冰霜远程2,frost_l2,0,92,51,125"
	loadArmyCfgData = armyStrArray
End Function


//============================================================================================
// Gloable Configuration Area
//============================================================================================
Function loadGlobalConfig
	//DELAY_OPERATE_RANK = Array(400,800,1200) //delay time level
	
	townFlags = Array(true, true, true, true, true, true, true, true)
	
	//build army
	gBuildArmy = 102, gBuildArmyNum=1, gBuildArmyMix = ""
	gCityBuildArmy = Array(-1, -1, -1, -1, 102, 102, -1, 102)
	
	//build tool
	gBuildTool=4, gCityBuildTool  = Array(-1,-1,-1,-1,3,3,3,4)
	
	gTimer = 30, gTimerPriority = 20, gCityRecruitTimer = 20
	gFirstStartCity = 0, gLastExePriorityNo = 0

	//1:youmu，2：wushi  | gFastCampaingFlag 0:normal, 1:fast+wood 2:fast+iron
	gCampaignType = 1, gCampaignMinTimer = 20, gFastCampaingFlag = 1
	
	//berimond campaign , buildType:1,zhangpeng,other:dec
	gBrmdEnable = false, gBrmdBuildType=0
	gTaskEnable = true, gTranEnable=false, gOutCmdEnable = True, gHelpRecruitEnable=True
	
	//SPY_SUC_RATE = 12
	//gAttackArmyLong = 80
	//gAttackArmyShort = 90
	
	//============================================================================================
	cmdArgs = "69,0,57#85,40,45#70,0,60#35,0,30#90,35,50#80,40,60#53,25,40#53,25,40#85,40,45"
	
	armyAtkArray(0) = Array(23,25,41,51,53,55,61,101,103,105)
	armyAtkArray(1) = Array(24,26,42,52,54,56,62,102,104,106,114)
	
	armyHsptRtn = Array(41, 42, 101, 102, 103, 104)
	
	//cannon fodder
	armyCannonFodder = Array(2, 4, 102, 106)
	
	//twMapArray(0) = "-1,552,568,0#-1,555,569,0#-1,553,572,0#-1,549,571,0#-1,549,566,0#0,556,573,0#0,552,576,0#0,549,575,0#0,546,572,0#0,546,576,0"
	//twMapArray(6) = "10,543,566,0#10,546,567,0#10,542,569,0#10,539,570,0#10,537,567,0#10,538,562,0#10,542,563,0#10,545,562,0"
	//twMapArray(2) = "20,549,566,0#20,549,562,0#20,548,559,0#20,555,556,0#20,553,559,0#20,552,563,0#20,555,556,0#20,556,552,0"
	twMapArray(4) = "30,565,568,0#30,568,565,0#30,565,564,0#30,562,566,0#30,559,563,0#30,558,566,0#30,560,569,0#30,559,572,0"
	twMapArray(3) = "1,637,737,1#1,634,733,1#1,641,738,1#1,629,739,1#1,637,729,1#1,641,730,1#1,646,734,1#1,635,744,1#1,627,733,1#1,629,727,1#1,624,741,1#1,638,746,1#1,644,743,1#1,635,749,1#1,648,739,1#1,644,726,1"
	twMapArray(5) = "2,633,664,2#2,637,662,2#2,639,667,2#2,634,668,2#2,633,659,2#2,637,657,2#2,644,666,2#2,637,671,2#2,629,658,2#2,627,667,2#2,628,662,2#2,644,659,2#2,632,655,2#2,623,665,2#2,636,652,2#2,634,675,2"
	twMapArray(1) = "3,626,704,3#3,622,702,3#3,632,704,3#3,624,708,3#3,630,709,3#3,636,700,3#3,629,695,3#3,625,697,3#3,620,698,3#3,617,703,3#3,620,706,3#3,617,709,3#3,636,695,3#3,627,690,3#3,626,716,3#3,632,715,3"
	//grigand map
	gSkipBrigandMap = Array(0,0,0,0,0,0,0,0)

	twNomads = "0,551,568,11,91#0,551,566,11,90#20,550,565,11,90#10,547,564,11,90"
	
	//twSamurai 
	//twForeign
	loadCdToolCfg()
End Function

Call main()